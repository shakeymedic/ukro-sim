<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UKRO High-Fidelity Scenario Simulator (Pro)</title>

  <!-- External Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

  <style>
    :root{
      --ukro-blue:#0033A0;
      --ukro-red:#C8102E;
      --ukro-navy:#001B44;
      --bg-light: #f3f4f6;
      --card-bg: #ffffff;
    }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: #1f2937; }
    
    /* Header & Branding */
    .ukro-header {
      background: linear-gradient(to right, #ffffff, #f0fdf4);
      border-bottom: 4px solid var(--ukro-blue);
    }
    
    /* Custom Scrollbar for Logs */
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
    .custom-scroll::-webkit-scrollbar-thumb:hover { background: #555; }

    /* Button Styles */
    .btn { transition: all 0.2s; border-bottom-width: 3px; position: relative; overflow: hidden; }
    .btn:active { transform: translateY(2px); border-bottom-width: 1px; margin-top: 2px; }
    .btn-primary { background-color: var(--ukro-blue); border-color: #00246f; color: white; }
    .btn-primary:hover { filter: brightness(110%); }
    .btn-secondary { background-color: var(--ukro-red); border-color: #8f0d22; color: white; }
    .btn-secondary:hover { filter: brightness(110%); }
    .btn-tertiary { background-color: #f59e0b; border-color: #b45309; color: white; }
    .btn-tertiary:hover { filter: brightness(110%); }
    .btn-ghost { background: white; color: var(--ukro-navy); border: 1px solid #e5e7eb; border-bottom: 3px solid #d1d5db; }
    .btn-ghost:hover { background: #f9fafb; }

    /* Animations */
    .flash-red {
      animation: flash-red-anim 1.5s ease-in-out infinite;
    }
    @keyframes flash-red-anim {
      0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); border-color: #fee2e2; }
      50% { box-shadow: 0 0 20px 0px rgba(220, 38, 38, 0.5); border-color: #dc2626; background-color: #fef2f2; }
    }
    
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Tab Logic */
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s; }
    .tab-btn.active { background-color: var(--ukro-blue); color: white; border-color: var(--ukro-navy); }
    
    /* Inner Card Tabs */
    .inner-tab-btn { @apply text-xs font-bold px-2 py-1 rounded text-gray-500 hover:bg-gray-100; }
    .inner-tab-btn.active { @apply bg-blue-100 text-blue-700; }

    /* Print Overrides */
    @media print {
      body { background: white; }
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      #setup-screen, #debrief-screen { border: none; box-shadow: none; }
      canvas { border: 1px solid #000; }
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">

  <!-- Navigation / Header -->
  <header class="ukro-header p-4 shadow-sm no-print">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-3">
        <!-- WMEBEM Logo -->
        <img src="images/wmebem-logo.png" alt="WMEBEM Logo" class="h-12 w-auto object-contain">
        <div>
          <h1 class="text-xl font-bold text-gray-900 leading-tight">UKRO Simulator</h1>
          <p class="text-xs text-gray-500 font-medium">High-Fidelity Instructor Tool</p>
        </div>
      </div>
      <div class="flex gap-3 items-center">
         <button onclick="document.documentElement.requestFullscreen()" class="btn btn-ghost px-3 py-1 text-sm rounded-lg font-semibold" title="Fullscreen">
            <i class="fa-solid fa-expand"></i>
         </button>
         <button onclick="document.getElementById('help-modal').showModal()" class="btn btn-ghost px-3 py-1 text-sm rounded-lg font-semibold">
           <i class="fa-solid fa-circle-question mr-1"></i> Help
         </button>
         <!-- UKRO Logo -->
         <img src="images/UKRO logo.png" alt="UKRO Logo" class="h-10 w-auto object-contain ml-2 hidden sm:block">
      </div>
    </div>
  </header>

  <!-- Main Content Area -->
  <main class="flex-grow w-full max-w-7xl mx-auto p-4 md:p-6">
    <div id="app" class="w-full">
      <!-- Content is injected here by JS -->
      <div class="flex justify-center items-center h-64">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-800"></div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t border-gray-200 mt-auto py-6 no-print">
    <div class="max-w-7xl mx-auto text-center text-gray-400 text-sm">
      <p>West Midlands Evidence Based Emergency Medicine &copy; 2024</p>
      <p class="text-xs mt-1">Licensed under CC BY-NC-SA 4.0</p>
    </div>
  </footer>

  <!-- Help Modal -->
  <dialog id="help-modal" class="p-0 rounded-xl shadow-2xl backdrop:bg-gray-900/50">
    <div class="w-[800px] max-w-full bg-white rounded-xl overflow-hidden">
      <div class="bg-blue-800 text-white p-4 flex justify-between items-center">
        <h3 class="font-bold text-lg"><i class="fa-solid fa-person-arrow-up-from-line mr-2"></i>U-STEP-OUT Guide</h3>
        <button onclick="document.getElementById('help-modal').close()" class="text-white hover:text-gray-200"><i class="fa-solid fa-xmark fa-lg"></i></button>
      </div>
      <div class="p-6 text-center">
         <!-- U-STEP OUT Image -->
         <img src="images/ustepout.png" alt="U-STEP OUT Guide" class="max-w-full h-auto mx-auto rounded border border-gray-200 shadow-sm">
         
         <div class="mt-6 flex justify-end">
          <button onclick="document.getElementById('help-modal').close()" class="btn btn-primary px-4 py-2 rounded">Close</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Application Logic -->
  <script>
    /**
     * UKRO Simulator - Single File Application
     * Refactored for modularity within a single scope.
     * v3.4 - Expanded Action Buttons & Casualty Tabs
     */

    /* ================= CONSTANTS & CONFIG ================= */
    const CONFIG = {
        CANVAS_W: 900,
        CANVAS_H: 520,
        COLORS: {
            blue: '#0033A0',
            red: '#C8102E',
            green: '#10b981',
            amber: '#f59e0b',
            slate: '#64748b'
        }
    };

    const ACVPU_SCALE = ['U', 'P', 'V', 'C', 'A'];

    /* ================= DATA STORE ================= */
    const FrameworkData = {
        scoresheets: {
            command: [
                'Arrival Message & Windscreen Report', 
                'Initial Scene Assessment', 
                '360 Degree Survey Completed',
                'Hazards Identified & Managed',
                'Tactical Plan Formulated',
                'Inner/Outer Cordons Established',
                'Dynamic Risk Assessment (DRA)',
                'Effective Communication with Team',
                'Liaison with other Agencies'
            ],
            technical: [
                'Vehicle Stabilisation (Initial)',
                'Vehicle Stabilisation (Secondary)',
                'Glass Management (Peel & Reveal)',
                'Tool Staging & Safety Area',
                'Space Creation Plan Agreed',
                'Hydraulic Tool Operations Safe',
                'Extrication Pathway Created',
                'Sharps Management / Protection'
            ],
            trauma: [
                'Scene Safety & PPE', 
                'Casualty Contact & Reassurance', 
                'C-Spine Manual Stabilisation', 
                '<C>ABCDE Primary Survey', 
                'Airway Management',
                'Oxygen Therapy Initiated',
                'Hemorrhage Control',
                'Fracture Immobilisation',
                'Casualty Protection (Blankets/Shields)',
                'ATMIST Handover'
            ]
        },
        actions: {
            Airway: ['Open Airway', 'Suction', 'OPA Inserted', 'NPA Inserted', 'i-gel / LMA', 'ET Tube (Medic)'],
            Breathing: ['High Flow O2 (15L)', 'Titrated O2', 'BVM Ventilation', 'Needle Decompression', 'Chest Seal Applied', 'Reassess RR'],
            Circulation: ['Check Pulse', 'Cap Refill', 'Direct Pressure', 'Tourniquet', 'Wound Packing', 'Pelvic Binder', 'IV Access', 'TXA Administered', 'Fluids Started'],
            Disability: ['Check ACVPU', 'Check Pupils', 'Check Blood Glucose', 'C-Spine Collar', 'Blocks & Tape'],
            Exposure: ['Cut Clothing', 'Check Back', 'Applying Blanket', 'Active Warming'],
            Drugs: ['Paracetamol', 'Ibuprofen', 'Entonox', 'Morphine (Medic)', 'Ondansetron']
        },
        injuries: {
            'Uninjured': { name: 'Uninjured', type: 'none', context:['rtc', 'trauma'], visual: 'Alert and orientated. No visible injuries.', vitals: { ACVPU: 'A', HR: 80, RR: 16, SBP: 120, SpO2: 99, CRT: 2 }, deterioration: {}, interventions: {} },
            'Minor Head Injury': { name: 'Minor Head Injury', type: 'minor', context:['rtc', 'trauma'], visual: 'Small cut to forehead. Dazed but talking.', vitals: { ACVPU: 'C', HR: 95, RR: 18, SBP: 130, SpO2: 98, CRT: 2 }, deterioration: { ACVPU: -0.5 }, interventions: { 'Immobilise': { key: 'Immobilise', effect: {}, stopsDeterioration: true, feedback: 'C-Spine immobilised.' } } },
            'Severe Head Injury': { name: 'Severe Head Injury', type: 'major', context:['rtc', 'trauma'], visual: 'Deep laceration to scalp. Incoherent speech. One pupil dilated.', vitals: { ACVPU: 'P', HR: 55, RR: 10, SBP: 180, SpO2: 92, CRT: 2 }, deterioration: { ACVPU: -1, RR: -1, SpO2: -2 }, interventions: { 'Airway Adjunct': { key: 'Airway Adjunct', effect: { RR: 4, SpO2: 4 }, stopsDeterioration: true, feedback: 'Airway secured.' } } },
            'Tension Pneumothorax': { name: 'Tension Pneumothorax', type: 'major', context:['rtc', 'trauma'], visual: 'Cyanosed lips. Veins distended. Struggling for breath.', vitals: { ACVPU: 'C', HR: 140, RR: 35, SBP: 80, SpO2: 85, CRT: 4 }, deterioration: { SpO2: -4, SBP: -5, HR: 5, CRT: 1 }, interventions: { 'Needle Decompression': { key: 'Needle Decompression', effect: { SpO2: 12, SBP: 15, RR: -10 }, stopsDeterioration: true, feedback: 'Decompression successful. Hiss heard.' } } },
            'Catastrophic Haemorrhage': { name: 'Catastrophic Haemorrhage', type: 'major', context:['rtc', 'trauma'], visual: 'Arterial bleed from limb. Pool of blood forming rapidly.', vitals: { ACVPU: 'V', HR: 150, RR: 30, SBP: 75, SpO2: 90, CRT: 5 }, deterioration: { SBP: -10, HR: 5, ACVPU: -1, CRT: 1 }, interventions: { 'Apply Tourniquet': { key: 'Apply Tourniquet', effect: { SBP: 20, HR: -20 }, stopsDeterioration: true, feedback: 'Tourniquet tight. Bleeding controlled.' } } },
            'Femur Fracture': { name: 'Femur Fracture', type: 'major', context:['rtc', 'trauma'], visual: 'Thigh swollen and deformed. Screaming in pain.', vitals: { ACVPU: 'A', HR: 120, RR: 24, SBP: 100, SpO2: 97, CRT: 3 }, deterioration: { SBP: -4, HR: 3 }, interventions: { 'Traction Splint': { key: 'Traction Splint', effect: { HR: -10, SBP: 5 }, stopsDeterioration: true, feedback: 'Traction applied. Pain reduced.' } } },
            'Flail Chest': { name: 'Flail Chest', type: 'major', context:['rtc', 'trauma'], visual: 'Paradoxical chest movement on left side. Shallow breathing.', vitals: { ACVPU: 'A', HR: 125, RR: 30, SBP: 110, SpO2: 88, CRT: 2 }, deterioration: { SpO2: -3, RR: 1 }, interventions: { 'Assist Ventilation': { key: 'Assist Ventilation', effect: { SpO2: 8, RR: -5 }, stopsDeterioration: true, feedback: 'BVM Ventilation initiated.' } } },
            'Spinal Injury (C-Spine)': { name: 'Spinal Injury (C-Spine)', type: 'major', context:['rtc'], visual: 'Complaining of severe neck pain. Pins and needles in fingers.', vitals: { ACVPU: 'A', HR: 70, RR: 16, SBP: 110, SpO2: 98, CRT: 2 }, deterioration: {}, interventions: { 'Collar & Blocks': { key: 'Collar & Blocks', effect: {}, stopsDeterioration: true, feedback: 'Full immobilisation applied.' } } },
            'Burn (Chemical)': { name: 'Chemical Burn', type: 'moderate', context:['trauma'], visual: 'Redness and blistering on arm. Strong chemical smell.', vitals: { ACVPU: 'A', HR: 110, RR: 22, SBP: 120, SpO2: 98, CRT: 2 }, deterioration: { HR: 2 }, interventions: { 'Irrigation': { key: 'Irrigation', effect: { HR: -10 }, stopsDeterioration: true, feedback: 'Wound irrigated copiously.' } } },
            'Cardiac Arrest (Electrocution)': { name: 'Cardiac Arrest', type: 'critical', context:['trauma'], visual: 'Unresponsive. Not breathing. Electrical burns visible.', vitals: { ACVPU: 'U', HR: 0, RR: 0, SBP: 0, SpO2: 0, CRT: 0 }, deterioration: {}, interventions: { 'CPR & Defib': { key: 'CPR & Defib', effect: { HR: 80, SBP: 100, SpO2: 90, ACVPU: 'U' }, stopsDeterioration: true, feedback: 'ROSC Achieved.' } } }
        },
        ample: {
            allergies: ['NKDA', 'Penicillin', 'Latex', 'Nuts', 'Morphine'],
            medications: ['None', 'Warfarin', 'Apixaban', 'Insulin', 'Salbutamol', 'Bisoprolol'],
            pastHistory: ['Asthma', 'T2 Diabetes', 'Hypertension', 'Ischemic Heart Disease', 'Epilepsy', 'None'],
            lastMeal: ['Breakfast 2hrs ago', 'Sandwich at lunch', 'Tea', 'Fasted'],
            events: ['Driving home', 'Passenger', 'Cyclist', 'Working at height', 'Industrial accident']
        },
        vehicles: {
            'Saloon': { type: 'Saloon Car', capacity: 5, isEV: false, hasUHSS: false },
            'SUV': { type: 'SUV', capacity: 7, isEV: false, hasUHSS: true },
            'Hatchback': { type: 'Hatchback', capacity: 5, isEV: false, hasUHSS: false },
            'Tesla Model 3': { type: 'Tesla Model 3', capacity: 5, isEV: true, hasUHSS: true },
            'Van': { type: 'Commercial Van', capacity: 3, isEV: false, hasUHSS: false }
        },
        hazards: [
            { type: 'Fuel Spill', minR: 35, maxR: 70 },
            { type: 'Fire', minR: 15, maxR: 28 },
            { type: 'Wall', width_m: 4, height_m: 0.5 },
            { type: 'Lamppost' },
            { type: 'Battery Fire', minR: 20, maxR: 35 },
            { type: 'Chemical Drum' }
        ]
    };

    /* ================= UTILITY FUNCTIONS ================= */
    const Utils = {
        rand: (min, max) => Math.random() * (max - min) + min,
        randInt: (min, max) => Math.floor(Math.random() * (max - min + 1) + min),
        choice: (arr) => arr[Math.floor(Math.random() * arr.length)],
        clamp: (v, lo, hi) => Math.max(lo, Math.min(hi, v)),
        
        rotateX: (x, y, deg) => {
             const r = (deg * Math.PI) / 180;
             return x * Math.cos(r) - y * Math.sin(r);
        },
        rotateY: (x, y, deg) => {
             const r = (deg * Math.PI) / 180;
             return x * Math.sin(r) + y * Math.cos(r);
        },
        
        generateId: () => Math.random().toString(36).substr(2, 9)
    };

    /* ================= CLASSES ================= */

    /**
     * Handles the logic for creating random scenarios
     */
    class ScenarioGenerator {
        static createCasualty(id, context, forcedInjuries = []) {
            const injuryKeys = Object.keys(FrameworkData.injuries).filter(k => FrameworkData.injuries[k].context.includes(context));
            
            // Determine injuries based on forced input or random choice
            let selectedInjuries = [];
            const forced = forcedInjuries[id] || [];
            
            if (forced.length > 0) {
                forced.forEach(val => {
                    if (val === 'Random') selectedInjuries.push(Utils.choice(injuryKeys));
                    else if (val && val !== 'None') selectedInjuries.push(val);
                });
            } else {
                // Completely random default
                selectedInjuries.push(Math.random() > 0.3 ? Utils.choice(injuryKeys) : 'Uninjured');
            }

            // Deduplicate
            selectedInjuries = [...new Set(selectedInjuries)];
            if (selectedInjuries.length === 0) selectedInjuries.push('Uninjured');

            // Combine vitals logic
            const injuriesData = selectedInjuries.map(k => ({...FrameworkData.injuries[k], key: k}));
            
            // Base vitals
            let combinedVitals = { ACVPU: 'A', HR: 80, RR: 16, SBP: 120, SpO2: 99, CRT: 2 };
            let combinedDeterioration = {};
            let interventions = {};
            let visualDescriptions = [];

            injuriesData.forEach(inj => {
                // Visuals
                if(inj.visual) visualDescriptions.push(inj.visual);

                // Vitals: take the "worst" of each category
                if (ACVPU_SCALE.indexOf(inj.vitals.ACVPU) < ACVPU_SCALE.indexOf(combinedVitals.ACVPU)) combinedVitals.ACVPU = inj.vitals.ACVPU;
                if (inj.vitals.SBP < combinedVitals.SBP) combinedVitals.SBP = inj.vitals.SBP;
                if (inj.vitals.SpO2 < combinedVitals.SpO2) combinedVitals.SpO2 = inj.vitals.SpO2;
                if (inj.vitals.CRT > combinedVitals.CRT) combinedVitals.CRT = inj.vitals.CRT;
                // HR/RR deviate from normal
                if (Math.abs(inj.vitals.HR - 80) > Math.abs(combinedVitals.HR - 80)) combinedVitals.HR = inj.vitals.HR;
                if (Math.abs(inj.vitals.RR - 16) > Math.abs(combinedVitals.RR - 16)) combinedVitals.RR = inj.vitals.RR;

                // Merge Deterioration
                Object.entries(inj.deterioration || {}).forEach(([k, v]) => {
                    combinedDeterioration[k] = (combinedDeterioration[k] || 0) + v;
                });

                // Merge Interventions
                Object.assign(interventions, inj.interventions);
            });

            return {
                id: id,
                age: Utils.randInt(18, 85),
                injuries: injuriesData,
                visualDescription: visualDescriptions.join(' ') || "Patient appears stable.",
                vitals: combinedVitals,
                initialVitals: {...combinedVitals},
                deterioration: combinedDeterioration,
                interventions: interventions,
                treatedInjuries: new Set(),
                overrideState: 'normal', // normal, arrest, stabilised, handed_over
                vitalsHistory: [],
                ample: {
                    A: Utils.choice(FrameworkData.ample.allergies),
                    M: Utils.choice(FrameworkData.ample.medications),
                    P: Utils.choice(FrameworkData.ample.pastHistory),
                    L: Utils.choice(FrameworkData.ample.lastMeal),
                    E: Utils.choice(FrameworkData.ample.events)
                }
            };
        }

        static createRTC(config) {
            const vehicleCount = parseInt(config.vehicles || 2);
            const patientCount = parseInt(config.patients || 2);
            const vehicles = [];
            const casualties = [];
            
            // Layout
            const isTJunction = Math.random() > 0.5;

            // Create Vehicles
            const vKeys = Object.keys(FrameworkData.vehicles);
            for(let i=0; i<vehicleCount; i++) {
                const type = Utils.choice(vKeys);
                const proto = FrameworkData.vehicles[type];
                
                // Position logic
                let x, y, rotation;
                if (isTJunction) {
                    x = (i===0) ? CONFIG.CANVAS_W * 0.45 : CONFIG.CANVAS_W * 0.55;
                    y = (i===0) ? CONFIG.CANVAS_H * 0.4 : CONFIG.CANVAS_H * 0.6;
                    rotation = (i===0) ? Utils.rand(-10, 10) : Utils.rand(80, 100);
                } else {
                    x = CONFIG.CANVAS_W * (0.35 + i*0.2);
                    y = CONFIG.CANVAS_H * 0.5 + Utils.rand(-20, 20);
                    rotation = Utils.rand(-15, 15);
                }

                vehicles.push({
                    id: i,
                    label: String.fromCharCode(65+i),
                    ...proto,
                    x, y, rotation,
                    color: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b'][i % 4],
                    damage: 'Frontal Impact'
                });
            }

            // Create Casualties
            for(let i=0; i<patientCount; i++) {
                casualties.push(this.createCasualty(i, 'rtc', config.presetInjuries));
            }

            // Assign Casualties to Vehicles (roughly)
            vehicles.forEach((v, idx) => {
                v.passengers = casualties.filter((_, ci) => ci % vehicles.length === idx);
            });

            // Hazards
            const hazards = [];
            const hazardPool = FrameworkData.hazards;
            
            // Force hazards
            (config.forceHazards || []).forEach(hType => {
                const templ = hazardPool.find(h => h.type === hType);
                if(templ) hazards.push(this._spawnHazard(templ));
            });
            
            // Random hazards
            if (Math.random() < (config.hazardProb || 0.5)) {
                const h = this._spawnHazard(Utils.choice(hazardPool));
                if (h) hazards.push(h);
            }

            return {
                type: 'RTC',
                title: 'Road Traffic Collision',
                location: isTJunction ? 'Urban Junction' : 'A-Road',
                timeLimit: 20,
                vehicles,
                casualties,
                hazards,
                layout: isTJunction ? 'T-Junction' : 'Head-On',
                scoresheet: {}
            };
        }

        static createTrauma(config) {
            const patientCount = parseInt(config.patients || 2);
            const casualties = [];
            for(let i=0; i<patientCount; i++) {
                casualties.push(this.createCasualty(i, 'trauma', config.presetInjuries));
            }

            const hazards = [];
            (config.forceHazards || []).forEach(hType => {
                const templ = FrameworkData.hazards.find(h => h.type === hType);
                if(templ) hazards.push(this._spawnHazard(templ));
            });

            return {
                type: 'Trauma',
                title: 'Industrial/Domestic Trauma',
                location: 'Industrial Estate',
                timeLimit: 15,
                vehicles: [],
                casualties,
                hazards,
                layout: 'Open Area',
                scoresheet: {}
            };
        }

        static _spawnHazard(template) {
            if(!template) return null;
            return {
                ...template,
                x: Utils.rand(100, CONFIG.CANVAS_W - 100),
                y: Utils.rand(100, CONFIG.CANVAS_H - 100),
                rotation: Utils.rand(0, 360)
            };
        }
    }

    /**
     * Canvas Drawing Logic
     */
    class Renderer {
        static draw(canvas, scenario) {
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;

            // Reset
            ctx.clearRect(0,0,w,h);

            // Apply Zoom Scale (1.5x)
            ctx.save();
            ctx.translate(w / 2, h / 2);
            ctx.scale(1.5, 1.5);
            ctx.translate(-w / 2, -h / 2);

            // Ground
            ctx.fillStyle = '#e2e8f0'; // Road/Concrete
            ctx.fillRect(0,0,w,h);
            
            // Grass verges
            ctx.fillStyle = '#dcfce7';
            ctx.fillRect(0,0,w, h*0.1);
            ctx.fillRect(0,h*0.9,w, h*0.1);

            // Road Markings
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 4;
            ctx.setLineDash([20, 20]);
            
            if (scenario.type === 'RTC') {
                if (scenario.layout === 'T-Junction') {
                    // Main road horizontal
                    ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); ctx.stroke();
                    // Side road vertical
                    ctx.beginPath(); ctx.moveTo(w/2, h/2); ctx.lineTo(w/2, h); ctx.stroke();
                } else {
                    // Single road
                    ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); ctx.stroke();
                }
            }
            ctx.setLineDash([]);

            // Draw Hazards
            scenario.hazards.forEach(haz => this._drawHazard(ctx, haz));

            // Draw Vehicles
            scenario.vehicles.forEach(veh => this._drawVehicle(ctx, veh));

            // Draw Casualties (if loose)
            if (scenario.type === 'Trauma') {
                scenario.casualties.forEach((cas, i) => {
                    const cx = w/2 + (i%2===0?50:-50) + Utils.rand(-20,20);
                    const cy = h/2 + (Math.floor(i/2)*50) + Utils.rand(-20,20);
                    this._drawCasualty(ctx, cx, cy, `C${i+1}`);
                });
            }
            
            // Restore context (remove scale)
            ctx.restore();
        }

        static _drawVehicle(ctx, v) {
            ctx.save();
            ctx.translate(v.x, v.y);
            ctx.rotate((v.rotation * Math.PI) / 180);

            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            this._roundRect(ctx, -55, -28, 110, 56, 8, true, false);

            // Body
            ctx.fillStyle = v.color;
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 2;
            this._roundRect(ctx, -50, -25, 100, 50, 6, true, true);

            // Windscreen
            ctx.fillStyle = '#cbd5e1';
            this._roundRect(ctx, -35, -20, 70, 40, 4, true, false);

            // Roof Label
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.font = 'bold 20px Inter';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(v.label, 0, 0);

            // Indicators
            if(v.isEV) {
                ctx.fillStyle = '#10b981';
                this._roundRect(ctx, -48, -45, 30, 15, 4, true, false);
                ctx.fillStyle = '#fff'; ctx.font = 'bold 10px Inter'; ctx.fillText('EV', -33, -37);
            }
            if(v.hasUHSS) {
                ctx.fillStyle = '#64748b';
                this._roundRect(ctx, 18, -45, 30, 15, 4, true, false);
                ctx.fillStyle = '#fff'; ctx.font = 'bold 8px Inter'; ctx.fillText('UHSS', 33, -37);
            }

            // Casualties inside
            if(v.passengers && v.passengers.length > 0) {
                 v.passengers.forEach((p, idx) => {
                     const px = (idx % 2 === 0) ? -10 : 10;
                     const py = (idx < 2) ? -10 : 10;
                     ctx.fillStyle = '#ef4444';
                     ctx.beginPath(); ctx.arc(px, py, 6, 0, Math.PI*2); ctx.fill();
                     ctx.fillStyle = 'white'; ctx.font='8px Inter'; ctx.fillText(`C${p.id+1}`, px, py);
                 });
            }

            ctx.restore();
        }

        static _drawHazard(ctx, h) {
            ctx.save();
            ctx.translate(h.x, h.y);
            ctx.rotate((h.rotation || 0) * Math.PI/180);

            if (h.type.includes('Fire')) {
                ctx.fillStyle = 'rgba(245, 158, 11, 0.4)';
                ctx.beginPath(); ctx.arc(0,0, h.r || 30, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#dc2626';
                ctx.font = '24px serif'; ctx.textAlign='center'; ctx.fillText('ðŸ”¥', 0, 8);
            } else if (h.type === 'Fuel Spill') {
                ctx.fillStyle = 'rgba(59, 130, 246, 0.3)';
                ctx.beginPath(); ctx.ellipse(0,0, 60, 30, 0, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#1e3a8a'; ctx.font='10px Inter'; ctx.fillText('Fuel', -10, 0);
            } else if (h.type === 'Wall') {
                ctx.fillStyle = '#71717a';
                ctx.fillRect(-40, -5, 80, 10);
            } else {
                ctx.fillStyle = '#facc15';
                ctx.beginPath(); ctx.moveTo(0, -15); ctx.lineTo(15, 10); ctx.lineTo(-15, 10); ctx.fill();
                ctx.fillStyle = 'black'; ctx.font='bold 14px Inter'; ctx.textAlign='center'; ctx.fillText('!', 0, 5);
            }
            ctx.restore();
        }
        
        static _drawCasualty(ctx, x, y, label) {
            ctx.fillStyle = '#ef4444';
            ctx.beginPath(); ctx.arc(x, y, 10, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'white'; ctx.font='bold 10px Inter'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(label, x, y);
        }

        static _roundRect(ctx, x, y, w, h, r, fill, stroke) {
            ctx.beginPath();
            ctx.roundRect(x, y, w, h, r);
            if(fill) ctx.fill();
            if(stroke) ctx.stroke();
        }
    }

    /**
     * Main App Controller
     */
    class App {
        constructor() {
            this.state = {
                view: 'menu', // menu, setup, live, debrief
                scenario: null,
                logs: [],
                simRunning: false,
                simTime: 0,
                timers: {
                    sim: null,
                    clock: null
                }
            };
            this.charts = {};
            
            // Try loading saved state
            this.loadState();
            
            // Initialization
            this.render();
        }

        /* --- LOGIC --- */
        
        // --- Persistence Logic ---
        saveState() {
            // Because Sets can't be JSON serialized easily, we convert them to arrays
            if(this.state.scenario) {
                this.state.scenario.casualties.forEach(c => {
                    c.treatedInjuriesArray = Array.from(c.treatedInjuries);
                });
            }
            localStorage.setItem('ukro_sim_state', JSON.stringify(this.state));
        }

        loadState() {
            const saved = localStorage.getItem('ukro_sim_state');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    this.state = parsed;
                    
                    // Rehydrate Sets
                    if(this.state.scenario) {
                         this.state.scenario.casualties.forEach(c => {
                            c.treatedInjuries = new Set(c.treatedInjuriesArray || []);
                        });
                    }
                    
                    // If we were running, stay paused on reload so user can orient themselves
                    if (this.state.view === 'live') {
                         this.state.simRunning = false;
                    }
                } catch(e) {
                    console.error("Failed to load save state", e);
                    localStorage.removeItem('ukro_sim_state');
                }
            }
        }
        
        clearState() {
            localStorage.removeItem('ukro_sim_state');
            this.state.scenario = null;
            this.state.logs = [];
            this.state.simTime = 0;
            this.state.simRunning = false;
        }

        generateScenario(type, config) {
            // Safety check
            if (this.state.scenario && this.state.view !== 'menu' && !confirm("A scenario is currently active. Overwrite it?")) return;

            if (type === 'rtc') {
                this.state.scenario = ScenarioGenerator.createRTC(config);
            } else {
                this.state.scenario = ScenarioGenerator.createTrauma(config);
            }
            this.state.view = 'setup';
            this.state.logs = []; // Clear logs
            this.addLog('Scenario generated.', 'system');
            this.saveState();
            this.render();
            
            // Draw canvas after DOM update
            setTimeout(() => {
                const cvs = document.getElementById('setupCanvas');
                if(cvs) Renderer.draw(cvs, this.state.scenario);
            }, 50);
        }

        startSimulation() {
            this.state.view = 'live';
            this.state.simRunning = true;
            // Only reset time if it's 0 (fresh start)
            if(this.state.simTime === 0) {
                 this.addLog(`Simulation started. Time limit: ${this.state.scenario.timeLimit} mins.`, 'command');
            } else {
                 this.addLog(`Simulation resumed at ${Math.floor(this.state.simTime/60)}:${(this.state.simTime%60).toString().padStart(2,'0')}.`, 'system');
            }
            
            this.saveState();
            this.render(); // This re-renders, putting Briefing AND Live UI on screen
            this.startTimers();
            
            // Scroll into view
            setTimeout(() => {
                const liveSection = document.getElementById('live-container');
                if(liveSection) liveSection.scrollIntoView({behavior: 'smooth'});
            }, 100);
        }

        startTimers() {
            clearInterval(this.state.timers.clock);
            clearInterval(this.state.timers.sim);

            // Clock (1s)
            this.state.timers.clock = setInterval(() => {
                if(!this.state.simRunning) return;
                this.state.simTime++;
                const timerEl = document.getElementById('sim-timer');
                if(timerEl) {
                    const m = Math.floor(this.state.simTime/60).toString().padStart(2,'0');
                    const s = (this.state.simTime%60).toString().padStart(2,'0');
                    timerEl.textContent = `${m}:${s}`;
                }
                // Periodic Auto-save (every 10s)
                if(this.state.simTime % 10 === 0) this.saveState();
            }, 1000);

            // Simulation Tick (5s)
            this.state.timers.sim = setInterval(() => {
                if(!this.state.simRunning) return;
                this.tick();
            }, 5000);
        }

        togglePause() {
            this.state.simRunning = !this.state.simRunning;
            const btn = document.getElementById('pauseBtn');
            if(btn) {
                btn.innerHTML = this.state.simRunning ? '<i class="fa-solid fa-pause mr-2"></i>Pause' : '<i class="fa-solid fa-play mr-2"></i>Resume';
                btn.className = this.state.simRunning ? 'btn btn-secondary px-4 py-2 rounded shadow' : 'btn btn-primary px-4 py-2 rounded shadow';
            }
            this.addLog(this.state.simRunning ? 'Simulation Resumed' : 'Simulation Paused', 'system');
            this.saveState();
        }

        tick() {
            let updateNeeded = false;
            this.state.scenario.casualties.forEach(cas => {
                // Record history
                cas.vitalsHistory.push({ t: this.state.simTime, ...cas.vitals });

                // Deterioration logic
                if (cas.overrideState === 'arrest') {
                    // Flatline
                    cas.vitals = { ACVPU: 'U', HR: 0, RR: 0, SBP: 0, SpO2: 0, CRT: 0 };
                    return;
                }
                
                if (cas.overrideState === 'stabilised' || cas.overrideState === 'handed_over') return;

                // Apply organic deterioration
                let deteriorated = false;
                Object.entries(cas.deterioration).forEach(([k, delta]) => {
                    // Only if injuries relating to this aren't treated (simplified logic: check if any treated)
                    // In a complex app, we'd map specific injuries to specific vitals. 
                    // Here, we stop det. if ALL injuries are treated.
                    const allTreated = cas.injuries.every(i => cas.treatedInjuries.has(i.key));
                    
                    if (!allTreated && delta !== 0) {
                        const prev = cas.vitals[k];
                        if (k === 'ACVPU') {
                            const idx = ACVPU_SCALE.indexOf(prev);
                            const newIdx = Utils.clamp(idx + delta, 0, 4);
                            cas.vitals.ACVPU = ACVPU_SCALE[newIdx];
                            if(idx !== newIdx) deteriorated = true;
                        } else {
                            cas.vitals[k] = Math.max(0, Math.round(prev + delta));
                            if(cas.vitals[k] !== prev) deteriorated = true;
                        }
                    }
                });

                // Random noise
                cas.vitals.HR += Math.random() > 0.7 ? (Math.random()>0.5?1:-1) : 0;
                cas.vitals.RR += Math.random() > 0.8 ? (Math.random()>0.5?1:-1) : 0;

                // Check critical thresholds
                if (cas.vitals.SBP < 50 && cas.vitals.HR > 0) {
                    this.addLog(`Casualty ${cas.id+1} is CRITICAL (Hypovolaemia)`, 'bad');
                    document.getElementById(`cas-card-${cas.id}`)?.classList.add('flash-red');
                }
            });

            this.updateLiveVitals();
        }

        applyIntervention(casId, injKey, intKey, btn) {
            const cas = this.state.scenario.casualties.find(c => c.id == casId);
            const inj = cas.injuries.find(i => i.key === injKey);
            const action = inj.interventions[intKey];

            // Apply Effects
            Object.entries(action.effect || {}).forEach(([k,v]) => {
                if(k === 'RR' || k === 'SpO2') cas.vitals[k] += v;
                // etc
            });

            if (action.stopsDeterioration) {
                cas.treatedInjuries.add(injKey);
            }

            // UI Feedback
            this.addLog(`C${parseInt(casId)+1}: ${action.feedback}`, 'good');
            if(btn) {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.innerHTML = `<i class="fa-solid fa-check mr-1"></i> Done`;
            }
            this.saveState();
        }
        
        logAction(casId, actionText) {
            this.addLog(`C${parseInt(casId)+1}: ${actionText}`, 'good');
        }
        
        handoverPatient(casId) {
            if(confirm("Confirm handover to ambulance service? Patient monitoring will stop.")) {
                const cas = this.state.scenario.casualties.find(c => c.id == casId);
                cas.overrideState = 'handed_over';
                this.addLog(`C${parseInt(casId)+1}: Handed over to Ambulance Service.`, 'command');
                this.renderLive(document.getElementById('live-container')); // Re-render to update UI state
            }
        }

        addLog(msg, type='info') {
            const time = new Date().toLocaleTimeString('en-GB', { hour12: false });
            this.state.logs.push({ time, msg, type });
            const logBox = document.getElementById('log-container');
            if (logBox) {
                const color = type==='good'?'text-green-600':type==='bad'?'text-red-600':type==='command'?'text-amber-600':'text-gray-600';
                const div = document.createElement('div');
                div.className = `text-sm py-1 border-b border-gray-100 ${color}`;
                div.innerHTML = `<span class="text-xs text-gray-400 font-mono mr-2">[${time}]</span> ${msg}`;
                logBox.prepend(div); // Add to top
                // Limit log size in DOM for performance?
                if(logBox.children.length > 100) logBox.lastChild.remove();
            }
        }

        endSimulation() {
            clearInterval(this.state.timers.clock);
            clearInterval(this.state.timers.sim);
            this.state.view = 'debrief';
            this.state.simRunning = false;
            this.saveState();
            this.render();
            setTimeout(() => this.renderCharts(), 100);
        }
        
        resetApp() {
            if(confirm("Start a brand new scenario? This will clear current data.")) {
                this.clearState();
                this.state.view = 'menu';
                this.render();
            }
        }
        
        switchCasTab(casId, tabName) {
            document.querySelectorAll(`#cas-card-${casId} .inner-tab-content`).forEach(el => el.classList.add('hidden'));
            document.getElementById(`cas-tab-${casId}-${tabName}`).classList.remove('hidden');
            
            document.querySelectorAll(`#cas-card-${casId} .inner-tab-btn`).forEach(el => el.classList.remove('active'));
            document.querySelector(`#cas-card-${casId} [data-tab="${tabName}"]`).classList.add('active');
        }

        /* --- RENDERERS --- */

        render() {
            const app = document.getElementById('app');
            app.innerHTML = '';

            if (this.state.view === 'menu') {
                this.renderMenu(app);
            } else if (this.state.view === 'setup') {
                this.renderSetup(app);
            } else if (this.state.view === 'live') {
                // Combined View Strategy:
                // 1. Render Setup (Briefing)
                this.renderSetup(app);
                
                // 2. Hide the "Start" button group in the briefing
                const startBtn = app.querySelector('button[onclick="app.startSimulation()"]');
                if(startBtn && startBtn.parentElement) startBtn.parentElement.style.display = 'none';

                // 3. Append Live Simulation Container BELOW it
                const liveContainer = document.createElement('div');
                liveContainer.id = 'live-container';
                liveContainer.className = 'mt-8 pt-8 border-t-4 border-gray-300';
                app.appendChild(liveContainer);
                
                // 4. Render Live controls into new container
                this.renderLive(liveContainer);
                
                // 5. Ensure canvas is drawn (since renderSetup wiped it)
                setTimeout(() => {
                    const cvs = document.getElementById('setupCanvas');
                    if(cvs) Renderer.draw(cvs, this.state.scenario);
                }, 50);

            } else if (this.state.view === 'debrief') {
                this.renderDebrief(app);
            }
        }

        renderMenu(container) {
            container.innerHTML = `
            <div class="max-w-4xl mx-auto space-y-8 animate-fade-in">
                <div class="text-center space-y-2">
                    <h2 class="text-3xl font-bold text-gray-800">Select Scenario Type</h2>
                    <p class="text-gray-500">Choose a template to generate a randomized high-fidelity scenario.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- RTC Card -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-600 hover:shadow-xl transition cursor-pointer group" onclick="document.getElementById('rtc-config').classList.remove('hidden'); document.getElementById('menu-grid').classList.add('hidden')">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="h-12 w-12 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition">
                                <i class="fa-solid fa-car-burst text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800">RTC Scenario</h3>
                        </div>
                        <p class="text-sm text-gray-600">Road traffic collisions involving cars, heavy goods vehicles, or EVs. Includes entrapment and scene hazards.</p>
                    </div>

                    <!-- Trauma Card -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-red-600 hover:shadow-xl transition cursor-pointer group" onclick="document.getElementById('trauma-config').classList.remove('hidden'); document.getElementById('menu-grid').classList.add('hidden')">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="h-12 w-12 bg-red-100 rounded-lg flex items-center justify-center text-red-600 group-hover:bg-red-600 group-hover:text-white transition">
                                <i class="fa-solid fa-user-injured text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800">Trauma Scenario</h3>
                        </div>
                        <p class="text-sm text-gray-600">Industrial accidents, falls from height, or medical emergencies in complex environments.</p>
                    </div>
                </div>

                <!-- Config Forms (Hidden initially) -->
                <div id="rtc-config" class="hidden bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="font-bold text-lg mb-4 border-b pb-2">RTC Parameters</h3>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="text-xs font-bold text-gray-500">Vehicles</label><select id="rtc-v" class="w-full border p-2 rounded"><option>1</option><option selected>2</option><option>3</option></select></div>
                        <div><label class="text-xs font-bold text-gray-500">Patients</label><select id="rtc-p" class="w-full border p-2 rounded"><option>1</option><option selected>2</option><option>3</option><option>4</option></select></div>
                    </div>
                    <div class="mb-4">
                        <label class="text-xs font-bold text-gray-500">Forced Hazards</label>
                        <div class="flex gap-2 flex-wrap mt-1">
                            ${FrameworkData.hazards.map(h => `<label class="inline-flex items-center gap-1 text-sm bg-gray-50 px-2 py-1 rounded border cursor-pointer"><input type="checkbox" value="${h.type}" class="rtc-h"> ${h.type}</label>`).join('')}
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="app.generateScenario('rtc', {vehicles: document.getElementById('rtc-v').value, patients: document.getElementById('rtc-p').value, forceHazards: [...document.querySelectorAll('.rtc-h:checked')].map(c=>c.value)})" class="btn btn-primary px-6 py-2 rounded-lg w-full">Generate</button>
                        <button onclick="location.reload()" class="btn btn-ghost px-4 py-2 rounded-lg">Cancel</button>
                    </div>
                </div>

                <div id="trauma-config" class="hidden bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="font-bold text-lg mb-4 border-b pb-2">Trauma Parameters</h3>
                    <div class="mb-4">
                        <div><label class="text-xs font-bold text-gray-500">Patients</label><select id="trauma-p" class="w-full border p-2 rounded"><option>1</option><option selected>2</option><option>3</option></select></div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="app.generateScenario('trauma', {patients: document.getElementById('trauma-p').value})" class="btn btn-secondary px-6 py-2 rounded-lg w-full">Generate</button>
                        <button onclick="location.reload()" class="btn btn-ghost px-4 py-2 rounded-lg">Cancel</button>
                    </div>
                </div>
                
                <!-- ID for hiding grid -->
                <div id="menu-grid"></div> 
            </div>
            `;
        }

        renderSetup(container) {
            const s = this.state.scenario;
            container.innerHTML = `
            <div class="space-y-6 animate-fade-in">
                <!-- Top Bar -->
                <div class="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-200 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900"><i class="fa-solid fa-clipboard-list mr-2 text-blue-600"></i>Instructor Briefing</h2>
                        <p class="text-sm text-gray-500">Review generated scenario before starting.</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.print()" class="btn btn-ghost px-4 py-2 rounded"><i class="fa-solid fa-print mr-1"></i> Print</button>
                        <button onclick="app.startSimulation()" class="btn btn-primary px-6 py-2 rounded text-lg shadow-lg font-bold">Start Simulation <i class="fa-solid fa-play ml-2"></i></button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Canvas Visualization -->
                    <div class="lg:col-span-2 bg-white p-1 rounded-xl shadow border border-gray-200">
                        <div class="bg-gray-100 rounded-t-lg p-2 flex justify-between items-center border-b">
                            <span class="font-bold text-sm text-gray-600">Scene Layout: ${s.location}</span>
                            <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full font-bold">Time Limit: ${s.timeLimit} mins</span>
                        </div>
                        <canvas id="setupCanvas" width="${CONFIG.CANVAS_W}" height="${CONFIG.CANVAS_H}" class="w-full h-auto bg-gray-50"></canvas>
                    </div>

                    <!-- Details Column -->
                    <div class="space-y-4">
                        <!-- Casualty Briefs -->
                        ${s.casualties.map((c, i) => `
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-lg">Casualty ${i+1}</h4>
                                <span class="text-xs bg-gray-100 px-2 py-1 rounded">Age ${c.age}</span>
                            </div>
                            <div class="text-sm space-y-1 mb-3">
                                <p><span class="font-bold text-gray-500">Injuries:</span> ${c.injuries.map(j => j.name).join(', ')}</p>
                                <p><span class="font-bold text-gray-500">Vitals:</span> GCS ${c.vitals.ACVPU} | HR ${c.vitals.HR} | SpO2 ${c.vitals.SpO2}%</p>
                            </div>
                            <div class="bg-gray-50 p-2 rounded text-xs font-mono text-gray-600">
                                <strong>AMPLE:</strong> A:${c.ample.A}, M:${c.ample.M}, P:${c.ample.P}, L:${c.ample.L}, E:${c.ample.E}
                            </div>
                        </div>
                        `).join('')}

                        <!-- Hazards -->
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                            <h4 class="font-bold mb-2">Hazards & Risks</h4>
                            <div class="flex flex-wrap gap-2">
                                ${s.hazards.length ? s.hazards.map(h => `<span class="bg-amber-100 text-amber-800 text-xs font-bold px-2 py-1 rounded border border-amber-200"><i class="fa-solid fa-triangle-exclamation mr-1"></i>${h.type}</span>`).join('') : '<span class="text-gray-400 text-sm">None detected</span>'}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        renderLive(container) {
            container.innerHTML = `
            <div class="h-full flex flex-col gap-4 animate-fade-in">
                <!-- Top Control Bar -->
                <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center sticky top-0 z-10">
                    <div class="flex items-center gap-4">
                        <div class="bg-gray-900 text-red-500 font-mono text-2xl px-4 py-1 rounded font-bold border border-gray-700 shadow-inner" id="sim-timer">
                            ${Math.floor(this.state.simTime/60).toString().padStart(2,'0')}:${(this.state.simTime%60).toString().padStart(2,'0')}
                        </div>
                        <button id="pauseBtn" onclick="app.togglePause()" class="${this.state.simRunning ? 'btn btn-secondary' : 'btn btn-primary'} px-4 py-2 rounded shadow">
                            <i class="fa-solid fa-${this.state.simRunning ? 'pause' : 'play'} mr-2"></i>${this.state.simRunning ? 'Pause' : 'Resume'}
                        </button>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="app.addLog('Log entry marker added', 'system')" class="btn btn-ghost px-3 py-1 text-sm rounded"><i class="fa-solid fa-bookmark text-blue-500 mr-1"></i> Mark</button>
                        <button onclick="app.endSimulation()" class="btn btn-primary px-4 py-2 rounded shadow font-bold bg-red-700 border-red-900">Finish & Debrief</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow">
                    <!-- Left Column: Controls -->
                    <div class="space-y-4">
                        
                        <!-- Command & Control -->
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="font-bold text-gray-700 mb-3 border-b pb-2">Command & Control</h3>
                            <div class="space-y-1">
                                ${FrameworkData.scoresheets.command.map(txt => `<button onclick="app.addLog('${txt} completed', 'command'); this.classList.add('bg-green-100','text-green-800','border-green-200')" class="w-full p-2 text-xs border rounded hover:bg-gray-50 transition text-left"><i class="fa-solid fa-check-circle mr-1 text-gray-400"></i>${txt}</button>`).join('')}
                            </div>
                        </div>

                        <!-- Incident Log (Moved Up) -->
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-col h-64">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-gray-700 text-sm">Incident Log</h3>
                                <span class="text-xs text-gray-400">Live Feed</span>
                            </div>
                            <!-- Input moved to top -->
                            <div class="mb-2 flex gap-1">
                                <input type="text" id="manualLog" placeholder="Type entry..." class="flex-grow border rounded px-2 py-1 text-sm" onkeydown="if(event.key==='Enter') document.getElementById('logBtn').click()">
                                <button id="logBtn" onclick="const i=document.getElementById('manualLog'); if(i.value){app.addLog(i.value, 'info'); i.value='';}" class="btn btn-primary px-3 py-1 rounded text-xs">Add</button>
                            </div>
                            <!-- Log Container -->
                            <div id="log-container" class="flex-grow overflow-y-auto custom-scroll bg-gray-50 p-2 rounded border border-gray-100 font-mono text-xs flex flex-col-reverse"></div>
                        </div>

                        <!-- Technical Scoresheet (Separate) -->
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="font-bold text-gray-700 text-sm mb-2 border-b pb-1">Technical Assessments</h3>
                            <div class="space-y-1 max-h-40 overflow-y-auto custom-scroll">
                                ${FrameworkData.scoresheets.technical.map(i => `<label class="flex items-center gap-2 p-1 hover:bg-gray-50 rounded cursor-pointer text-sm"><input type="checkbox" onchange="app.addLog('Tech: ${i}', 'good')"> ${i}</label>`).join('')}
                            </div>
                        </div>

                        <!-- Medical Scoresheet (Separate) -->
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="font-bold text-gray-700 text-sm mb-2 border-b pb-1">Medical Assessments</h3>
                            <div class="space-y-1 max-h-40 overflow-y-auto custom-scroll">
                                ${FrameworkData.scoresheets.trauma.map(i => `<label class="flex items-center gap-2 p-1 hover:bg-gray-50 rounded cursor-pointer text-sm"><input type="checkbox" onchange="app.addLog('Med: ${i}', 'good')"> ${i}</label>`).join('')}
                            </div>
                        </div>

                    </div>

                    <!-- Right Column: Casualties -->
                    <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 auto-rows-min">
                        ${this.state.scenario.casualties.map(c => this.renderCasualtyCard(c)).join('')}
                    </div>
                </div>
            </div>
            `;
            // Initial log population
            this.state.logs.forEach(l => this.addLog(l.msg, l.type));
        }

        renderCasualtyCard(c) {
            if (c.overrideState === 'handed_over') {
                return `
                <div id="cas-card-${c.id}" class="bg-gray-100 rounded-xl border border-gray-200 p-6 text-center opacity-75">
                    <h3 class="font-bold text-gray-500 mb-2">Casualty ${c.id+1} Handed Over</h3>
                    <p class="text-sm text-gray-400">Patient care transferred to ambulance service.</p>
                </div>`;
            }

            // Generate Action Buttons based on Category
            const generateActionButtons = (category, list) => {
                return list.map(act => `<button onclick="app.logAction(${c.id}, '${act}')" class="text-left text-xs p-2 bg-gray-50 border rounded hover:bg-blue-50 hover:border-blue-200 hover:text-blue-700 transition">${act}</button>`).join('');
            };

            return `
            <div id="cas-card-${c.id}" class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col transition duration-300">
                <div class="bg-gray-50 p-3 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="font-bold text-gray-800"><i class="fa-solid fa-user-injured mr-2"></i>Casualty ${c.id+1}</h3>
                    <div class="flex gap-1">
                        <button onclick="this.classList.toggle('bg-red-600'); this.classList.toggle('text-white'); app.state.scenario.casualties[${c.id}].overrideState = 'arrest'; app.addLog('C${c.id+1} ARREST triggered', 'bad')" class="text-xs border border-red-200 text-red-700 px-2 py-1 rounded hover:bg-red-50">Arrest</button>
                        <button onclick="this.classList.toggle('bg-green-600'); this.classList.toggle('text-white'); app.state.scenario.casualties[${c.id}].overrideState = 'stabilised'; app.addLog('C${c.id+1} Stabilised', 'good')" class="text-xs border border-green-200 text-green-700 px-2 py-1 rounded hover:bg-green-50">Stable</button>
                        <button onclick="app.handoverPatient(${c.id})" class="text-xs border border-blue-200 text-blue-700 px-2 py-1 rounded hover:bg-blue-50" title="Handover to Ambulance">Handover</button>
                    </div>
                </div>
                
                <div class="p-4 space-y-3 flex-grow">
                    <!-- Visual Description -->
                    <div class="text-xs text-gray-500 italic bg-yellow-50 p-2 rounded border border-yellow-100">
                        <i class="fa-solid fa-eye mr-1"></i> ${c.visualDescription}
                    </div>

                    <!-- Vitals Display -->
                    <div id="vitals-${c.id}" class="bg-gray-900 text-green-400 font-mono p-3 rounded text-center shadow-inner tracking-widest text-sm relative">
                        Loading...
                    </div>

                    <!-- Inner Tabs -->
                    <div class="flex border-b border-gray-200">
                        <button class="inner-tab-btn active" data-tab="primary" onclick="app.switchCasTab(${c.id}, 'primary')">Primary Survey</button>
                        <button class="inner-tab-btn" data-tab="interventions" onclick="app.switchCasTab(${c.id}, 'interventions')">Interventions</button>
                        <button class="inner-tab-btn" data-tab="drugs" onclick="app.switchCasTab(${c.id}, 'drugs')">Drugs</button>
                    </div>

                    <!-- Tab Content: Primary Survey -->
                    <div id="cas-tab-${c.id}-primary" class="inner-tab-content space-y-2">
                        <div><p class="text-xs font-bold text-gray-400 mb-1">Airway</p><div class="grid grid-cols-2 gap-1">${generateActionButtons('Airway', FrameworkData.actions.Airway)}</div></div>
                        <div><p class="text-xs font-bold text-gray-400 mb-1">Breathing</p><div class="grid grid-cols-2 gap-1">${generateActionButtons('Breathing', FrameworkData.actions.Breathing)}</div></div>
                        <div><p class="text-xs font-bold text-gray-400 mb-1">Circulation</p><div class="grid grid-cols-2 gap-1">${generateActionButtons('Circulation', FrameworkData.actions.Circulation)}</div></div>
                    </div>

                    <!-- Tab Content: Interventions -->
                    <div id="cas-tab-${c.id}-interventions" class="inner-tab-content hidden space-y-2">
                        <div><p class="text-xs font-bold text-gray-400 mb-1">Disability & C-Spine</p><div class="grid grid-cols-2 gap-1">${generateActionButtons('Disability', FrameworkData.actions.Disability)}</div></div>
                        <div><p class="text-xs font-bold text-gray-400 mb-1">Exposure & Environment</p><div class="grid grid-cols-2 gap-1">${generateActionButtons('Exposure', FrameworkData.actions.Exposure)}</div></div>
                    </div>

                    <!-- Tab Content: Drugs -->
                    <div id="cas-tab-${c.id}-drugs" class="inner-tab-content hidden space-y-2">
                        <div><p class="text-xs font-bold text-gray-400 mb-1">Medication Admin</p><div class="grid grid-cols-2 gap-1">${generateActionButtons('Drugs', FrameworkData.actions.Drugs)}</div></div>
                    </div>

                </div>
            </div>`;
        }

        updateLiveVitals() {
            this.state.scenario.casualties.forEach(c => {
                const el = document.getElementById(`vitals-${c.id}`);
                if(el) {
                    if (c.overrideState === 'handed_over') return;

                    const v = c.vitals;
                    // Comparison Arrows
                    const arr = (curr, prev) => curr > prev ? 'â–²' : curr < prev ? 'â–¼' : '-';
                    // We need previous vitals (last in history)
                    const len = c.vitalsHistory.length;
                    const prev = len > 1 ? c.vitalsHistory[len-2] : c.initialVitals;

                    let html = '';
                    if (c.overrideState === 'arrest') {
                        html = '<span class="text-red-500 font-bold animate-pulse">CARDIAC ARREST - NO OUTPUT</span>';
                    } else {
                        html = `
                        <div class="grid grid-cols-3 gap-y-2">
                            <div><span class="text-xs text-gray-500 block">ACVPU</span>${v.ACVPU}</div>
                            <div><span class="text-xs text-gray-500 block">HR</span>${v.HR} <span class="text-xs">${arr(v.HR, prev.HR)}</span></div>
                            <div><span class="text-xs text-gray-500 block">RR</span>${v.RR} <span class="text-xs">${arr(v.RR, prev.RR)}</span></div>
                            <div><span class="text-xs text-gray-500 block">BP</span>${v.SBP}/<span class="text-xs">${Math.round(v.SBP*0.66)}</span></div>
                            <div><span class="text-xs text-gray-500 block">SpO2</span>${v.SpO2}% <span class="text-xs">${arr(v.SpO2, prev.SpO2)}</span></div>
                            <div><span class="text-xs text-gray-500 block">CRT</span>${v.CRT}s</div>
                        </div>`;
                    }
                    el.innerHTML = html;
                }
            });
        }

        renderDebrief(container) {
            container.innerHTML = `
            <div class="space-y-6 animate-fade-in no-print">
                <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-900">Scenario Debrief</h2>
                    <div class="flex gap-2">
                         <button onclick="window.print()" class="btn btn-tertiary px-4 py-2 rounded">Download PDF</button>
                         <button onclick="app.resetApp()" class="btn btn-primary px-4 py-2 rounded">New Scenario</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Timeline -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-lg mb-4 text-blue-800">Incident Timeline</h3>
                        <div class="space-y-2 font-mono text-sm max-h-96 overflow-y-auto border p-2 bg-gray-50 rounded">
                            ${this.state.logs.map(l => `<div class="${l.type==='bad'?'text-red-600':l.type==='good'?'text-green-600':''}"><span class="text-gray-400">[${l.time}]</span> ${l.msg}</div>`).join('')}
                        </div>
                    </div>
                    
                    <!-- Casualty Outcomes -->
                     <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-lg mb-4 text-blue-800">Casualty Outcome</h3>
                        <div class="space-y-4">
                            ${this.state.scenario.casualties.map(c => `
                                <div class="border-b pb-2">
                                    <p class="font-bold">Casualty ${c.id+1}</p>
                                    <div class="flex justify-between text-sm mt-1">
                                        <span>Initial GCS: ${c.initialVitals.ACVPU}</span>
                                        <span>Final GCS: ${c.vitals.ACVPU}</span>
                                        ${c.overrideState === 'handed_over' ? '<span class="text-blue-600 font-bold">Handed Over</span>' : ''}
                                    </div>
                                    <div class="h-40 mt-2 relative w-full">
                                        <canvas id="chart-${c.id}"></canvas>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- AMPLE Handover Summary -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-lg mb-4 text-blue-800">Ambulance Handover (AMPLE)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${this.state.scenario.casualties.map(c => `
                            <div class="p-4 border rounded-lg bg-gray-50">
                                <h4 class="font-bold text-md border-b pb-1 mb-2">Casualty ${c.id+1} (Age ${c.age})</h4>
                                <ul class="text-sm space-y-1">
                                    <li><strong>Allergies:</strong> ${c.ample.A}</li>
                                    <li><strong>Medications:</strong> ${c.ample.M}</li>
                                    <li><strong>Past History:</strong> ${c.ample.P}</li>
                                    <li><strong>Last Meal:</strong> ${c.ample.L}</li>
                                    <li><strong>Event:</strong> ${c.ample.E}</li>
                                </ul>
                                <div class="mt-2 pt-2 border-t text-xs text-gray-500">
                                    <strong>Injuries:</strong> ${c.injuries.map(i=>i.name).join(', ')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
            `;
        }
        
        renderCharts() {
            this.state.scenario.casualties.forEach(c => {
                const ctx = document.getElementById(`chart-${c.id}`);
                if (!ctx) return;
                
                // Destroy old chart if exists (though we re-render DOM, just safe keeping)
                if(this.charts[c.id]) this.charts[c.id].destroy();

                const labels = c.vitalsHistory.map(h => {
                    const m = Math.floor(h.t/60).toString().padStart(2,'0');
                    return `${m}:${(h.t%60).toString().padStart(2,'0')}`;
                });

                this.charts[c.id] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'HR', data: c.vitalsHistory.map(h=>h.HR), borderColor: 'red', borderWidth: 2, pointRadius: 0 },
                            { label: 'SBP', data: c.vitalsHistory.map(h=>h.SBP), borderColor: 'blue', borderWidth: 2, pointRadius: 0 },
                            { label: 'SpO2', data: c.vitalsHistory.map(h=>h.SpO2), borderColor: 'green', borderWidth: 2, pointRadius: 0, yAxisID: 'y1' }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            x: { display: false },
                            y: { beginAtZero: false },
                            y1: { position: 'right', min: 50, max: 100, grid: { drawOnChartArea: false } }
                        },
                        plugins: { legend: { display: true, labels: { boxWidth: 10, font: { size: 10 } } } }
                    }
                });
            });
        }
    }

    /* ================= INITIALIZATION ================= */
    const app = new App();

  </script>
</body>
</html>
