<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UKRO High-Fidelity Scenario Simulator (v2.3)</title>

  <!-- External Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --ukro-blue:#0033A0;
      --ukro-red:#C8102E;
      --ukro-navy:#001B44;
      --bg-light: #f3f4f6;
      --card-bg: #ffffff;
    }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: #1f2937; }
    
    .ukro-header {
      background: linear-gradient(to right, #ffffff, #f0fdf4);
      border-bottom: 4px solid var(--ukro-blue);
    }
    
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
    .custom-scroll::-webkit-scrollbar-thumb:hover { background: #555; }

    .btn { transition: all 0.2s; border-bottom-width: 3px; position: relative; overflow: hidden; }
    .btn:active { transform: translateY(2px); border-bottom-width: 1px; margin-top: 2px; }
    .btn-primary { background-color: var(--ukro-blue); border-color: #00246f; color: white; }
    .btn-primary:hover { filter: brightness(110%); }
    .btn-secondary { background-color: var(--ukro-red); border-color: #8f0d22; color: white; }
    .btn-secondary:hover { filter: brightness(110%); }
    .btn-tertiary { background-color: #f59e0b; border-color: #b45309; color: white; }
    .btn-ghost { background: white; color: var(--ukro-navy); border: 1px solid #e5e7eb; border-bottom: 3px solid #d1d5db; }
    .btn-ghost:hover { background: #f9fafb; }

    .flash-red { animation: flash-red-anim 1.5s ease-in-out infinite; }
    @keyframes flash-red-anim {
      0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); border-color: #fee2e2; }
      50% { box-shadow: 0 0 20px 0px rgba(220, 38, 38, 0.5); border-color: #dc2626; background-color: #fef2f2; }
    }
    
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .inner-tab-content { display: none; }
    .inner-tab-content.active { display: block; animation: fadeIn 0.3s; }
    .inner-tab-btn { @apply text-xs font-bold px-2 py-1 rounded text-gray-500 hover:bg-gray-100; cursor: pointer; }
    .inner-tab-btn.active { background-color: #dbeafe; color: #1d4ed8; }

    @media print {
      body { background: white; }
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      canvas { border: 1px solid #000; }
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">

  <!-- Header -->
  <header class="ukro-header p-4 shadow-sm no-print">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-3">
        <!-- WMEBEM Logo -->
        <img src="images/wmebem-logo.png" alt="WMEBEM Logo" class="h-12 w-auto object-contain" onerror="this.style.display='none'">
        <div>
            <h1 class="text-xl font-bold text-gray-900 leading-tight">UKRO Simulator <span class="text-blue-600 text-sm align-top">v2.3</span></h1>
            <p class="text-xs text-gray-500 font-medium">High-Fidelity Instructor Tool</p>
        </div>
      </div>
      <div class="flex gap-3 items-center">
         <button onclick="document.documentElement.requestFullscreen()" class="btn btn-ghost px-3 py-1 text-sm rounded-lg font-semibold" title="Fullscreen">
            <i class="fa-solid fa-expand"></i>
         </button>
         <button onclick="document.getElementById('help-modal').showModal()" class="btn btn-ghost px-3 py-1 text-sm rounded-lg font-semibold">
           <i class="fa-solid fa-circle-question mr-1"></i> Help
         </button>
         <!-- UKRO Logo -->
         <img src="images/UKRO logo.png" alt="UKRO Logo" class="h-10 w-auto object-contain ml-2 hidden sm:block" onerror="this.style.display='none'">
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow w-full max-w-7xl mx-auto p-4 md:p-6">
    <div id="app" class="w-full">
      <div class="flex justify-center items-center h-64">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-800"></div>
      </div>
    </div>
  </main>

  <!-- Help Modal -->
  <dialog id="help-modal" class="p-0 rounded-xl shadow-2xl backdrop:bg-gray-900/50">
    <div class="w-[800px] max-w-full bg-white rounded-xl overflow-hidden">
      <div class="bg-blue-800 text-white p-4 flex justify-between items-center">
        <h3 class="font-bold text-lg"><i class="fa-solid fa-person-arrow-up-from-line mr-2"></i>U-STEP-OUT Guide</h3>
        <button onclick="document.getElementById('help-modal').close()" class="text-white hover:text-gray-200"><i class="fa-solid fa-xmark fa-lg"></i></button>
      </div>
      <div class="p-6 text-center">
         <img src="images/ustepout.png" alt="U-STEP OUT Guide" class="max-w-full h-auto mx-auto rounded border border-gray-200 shadow-sm" onerror="this.style.display='none'; this.insertAdjacentHTML('afterend', '<p class=text-red-500>Image missing: images/ustepout.png</p>')">
         <div class="mt-6 flex justify-end">
          <button onclick="document.getElementById('help-modal').close()" class="btn btn-primary px-4 py-2 rounded">Close</button>
        </div>
      </div>
    </div>
  </dialog>

  <script>
    /* ================= CONSTANTS & CONFIG ================= */
    const CONFIG = {
        CANVAS_W: 900,
        CANVAS_H: 520,
    };
    const ACVPU_SCALE = ['U', 'P', 'V', 'C', 'A'];

    /* ================= DATA STORE ================= */
    const FrameworkData = {
        scoresheets: {
            command: ['Scene assessment', 'Tactical Plan', 'Communication', 'Risk Assessment', 'Inner/Outer Cordons', 'Team Briefing'],
            technical: ['Stabilisation (Pri)', 'Glass Management', 'Tool Staging', 'Space Creation', 'Extrication Path', 'Sharps Protection'],
            trauma: ['Scene Safety', 'C-Spine Control', '<C>ABCDE Survey', 'Oxygen Therapy', 'Haemorrhage Control', 'Splintage', 'ATMIST Handover']
        },
        actions: {
            Airway: ['Open Airway', 'Suction', 'OPA', 'NPA', 'i-gel', 'ET Tube'],
            Breathing: ['15L O2', 'Titrated O2', 'BVM', 'Needle Decomp', 'Chest Seal', 'Reassess RR'],
            Circulation: ['Check Pulse', 'Cap Refill', 'Direct Pressure', 'Tourniquet', 'Wound Packing', 'Pelvic Binder', 'IV Access', 'TXA', 'Fluids'],
            Disability: ['Check ACVPU', 'Pupils', 'Blood Glucose', 'Temp', 'Collar & Blocks'],
            Exposure: ['Cut Clothing', 'Check Back', 'Blanket', 'Active Warming'],
            Drugs: ['Paracetamol', 'Ibuprofen', 'Entonox', 'Morphine', 'Ondansetron']
        },
        injuries: {
            'Uninjured': { name: 'Uninjured', type: 'none', context:['rtc', 'trauma'], visual: 'Alert. No visible injuries.', vitals: { ACVPU: 'A', HR: 80, RR: 16, SBP: 120, SpO2: 99, CRT: 2 }, deterioration: {}, interventions: {} },
            'Minor Head Injury': { name: 'Minor Head Injury', type: 'minor', context:['rtc', 'trauma'], visual: 'Cut to forehead. Dazed.', vitals: { ACVPU: 'C', HR: 95, RR: 18, SBP: 130, SpO2: 98, CRT: 2 }, deterioration: { ACVPU: -0.2 }, interventions: { 'Immobilise': { key: 'Immobilise', effect: {}, stopsDeterioration: true, feedback: 'C-Spine immobilised.' } } },
            'Severe Head Injury': { name: 'Severe Head Injury', type: 'major', context:['rtc', 'trauma'], visual: 'Deep scalp lac. Incoherent.', vitals: { ACVPU: 'P', HR: 55, RR: 10, SBP: 180, SpO2: 92, CRT: 2 }, deterioration: { ACVPU: -0.5, RR: -0.5, SpO2: -1 }, interventions: { 'Airway Adjunct': { key: 'Airway Adjunct', effect: { RR: 4, SpO2: 4 }, stopsDeterioration: true, feedback: 'Airway secured.' } } },
            'Tension Pneumothorax': { name: 'Tension Pneumothorax', type: 'major', context:['rtc', 'trauma'], visual: 'Cyanosed. Veins distended. Struggling.', vitals: { ACVPU: 'C', HR: 140, RR: 35, SBP: 80, SpO2: 85, CRT: 4 }, deterioration: { SpO2: -2, SBP: -3, HR: 3, CRT: 0.5 }, interventions: { 'Needle Decompression': { key: 'Needle Decompression', effect: { SpO2: 12, SBP: 15, RR: -10 }, stopsDeterioration: true, feedback: 'Hiss heard. Stats improving.' } } },
            'Simple Pneumothorax': { name: 'Simple Pneumothorax', type: 'moderate', context:['rtc', 'trauma'], visual: 'Short of breath. Pain on inspiration.', vitals: { ACVPU: 'A', HR: 110, RR: 28, SBP: 115, SpO2: 93, CRT: 2 }, deterioration: { SpO2: -1, RR: 1 }, interventions: {} },
            'Catastrophic Haemorrhage': { name: 'Catastrophic Haemorrhage', type: 'major', context:['rtc', 'trauma'], visual: 'Arterial bleed. Pool of blood.', vitals: { ACVPU: 'V', HR: 150, RR: 30, SBP: 75, SpO2: 90, CRT: 5 }, deterioration: { SBP: -4, HR: 3, ACVPU: -0.5 }, interventions: { 'Apply Tourniquet': { key: 'Apply Tourniquet', effect: { SBP: 20, HR: -20 }, stopsDeterioration: true, feedback: 'Bleeding controlled.' } } },
            'Femur Fracture': { name: 'Femur Fracture', type: 'major', context:['rtc', 'trauma'], visual: 'Thigh deformed. Screaming.', vitals: { ACVPU: 'A', HR: 120, RR: 24, SBP: 100, SpO2: 97, CRT: 3 }, deterioration: { SBP: -2, HR: 2 }, interventions: { 'Traction Splint': { key: 'Traction Splint', effect: { HR: -10, SBP: 5 }, stopsDeterioration: true, feedback: 'Traction applied.' } } },
            'Flail Chest': { name: 'Flail Chest', type: 'major', context:['rtc', 'trauma'], visual: 'Paradoxical chest movement.', vitals: { ACVPU: 'A', HR: 125, RR: 30, SBP: 110, SpO2: 88, CRT: 2 }, deterioration: { SpO2: -2, RR: 0.5 }, interventions: { 'Assist Ventilation': { key: 'Assist Ventilation', effect: { SpO2: 8, RR: -5 }, stopsDeterioration: true, feedback: 'BVM initiated.' } } },
            'Cardiac Arrest': { name: 'Cardiac Arrest', type: 'critical', context:['trauma'], visual: 'Unresponsive. Not breathing.', vitals: { ACVPU: 'U', HR: 0, RR: 0, SBP: 0, SpO2: 0, CRT: 0 }, deterioration: {}, interventions: { 'CPR & Defib': { key: 'CPR & Defib', effect: { HR: 80, SBP: 100, SpO2: 90, ACVPU: 'U' }, stopsDeterioration: true, feedback: 'ROSC Achieved.' } } },
            'Spinal Injury (Thoracic)': { name: 'Spinal Injury (Thoracic)', type: 'major', context:['rtc'], visual: 'No movement in legs. Back pain.', vitals: { ACVPU: 'A', HR: 60, RR: 16, SBP: 85, SpO2: 98, CRT: 3 }, deterioration: { SBP: -1 }, interventions: {} },
            'Open Tib/Fib Fracture': { name: 'Open Tib/Fib Fracture', type: 'major', context:['rtc', 'trauma'], visual: 'Bone protruding from lower leg.', vitals: { ACVPU: 'A', HR: 110, RR: 20, SBP: 110, SpO2: 98, CRT: 2 }, deterioration: { HR: 2, SBP: -1 }, interventions: { 'Splinting': { key: 'Splinting', effect: { HR: -5 }, stopsDeterioration: true, feedback: 'Leg splinted.' } } },
            'Pelvic Fracture': { name: 'Pelvic Fracture', type: 'major', context:['rtc', 'trauma'], visual: 'Pelvic instability. Pain.', vitals: { ACVPU: 'A', HR: 130, RR: 26, SBP: 90, SpO2: 95, CRT: 3 }, deterioration: { SBP: -3, HR: 3 }, interventions: { 'Pelvic Binder': { key: 'Pelvic Binder', effect: { SBP: 10, HR: -10 }, stopsDeterioration: true, feedback: 'Binder applied.' } } }
        },
        ample: {
            allergies: ['NKDA', 'Penicillin', 'Latex', 'Nuts', 'Morphine', 'Codeine'],
            medications: ['None', 'Warfarin', 'Apixaban', 'Insulin', 'Salbutamol', 'Bisoprolol', 'Ramipril', 'Metformin'],
            pastHistory: ['Asthma', 'T2 Diabetes', 'Hypertension', 'Ischemic Heart Disease', 'Epilepsy', 'None', 'COPD', 'Previous MI'],
            lastMeal: ['Breakfast 2hrs ago', 'Sandwich at lunch', 'Tea', 'Fasted', 'Snack 1hr ago'],
            events: ['Driving home from work', 'Passenger in vehicle', 'Cyclist struck by car', 'Working at height', 'Industrial machinery accident', 'Fell down stairs']
        },
        vehicles: {
            'Saloon': { type: 'Saloon Car', capacity: 5, isEV: false, hasUHSS: false },
            'SUV': { type: 'SUV', capacity: 7, isEV: false, hasUHSS: true },
            'Tesla Model 3': { type: 'Tesla Model 3', capacity: 5, isEV: true, hasUHSS: true },
            'Van': { type: 'Commercial Van', capacity: 3, isEV: false, hasUHSS: false },
            'Hatchback': { type: 'Hatchback', capacity: 5, isEV: false, hasUHSS: false }
        },
        hazards: [
            { type: 'Fuel Spill', minR: 35, maxR: 70 },
            { type: 'Fire', minR: 15, maxR: 28 },
            { type: 'Wall', width_m: 4, height_m: 0.5 },
            { type: 'Lamppost' },
            { type: 'Battery Fire', minR: 20, maxR: 35 },
            { type: 'Chemical Drum' }
        ]
    };

    /* ================= UTILITY FUNCTIONS ================= */
    const Utils = {
        rand: (min, max) => Math.random() * (max - min) + min,
        randInt: (min, max) => Math.floor(Math.random() * (max - min + 1) + min),
        choice: (arr) => arr[Math.floor(Math.random() * arr.length)],
        clamp: (v, lo, hi) => Math.max(lo, Math.min(hi, v)),
        rotateX: (x, y, deg) => { const r = (deg * Math.PI) / 180; return x * Math.cos(r) - y * Math.sin(r); },
        rotateY: (x, y, deg) => { const r = (deg * Math.PI) / 180; return x * Math.sin(r) + y * Math.cos(r); }
    };

    /* ================= LOGIC CLASSES ================= */

    class ScenarioGenerator {
        static createCasualty(id, context, forcedInjuries = [], customVitals = null) {
            let injuryKeys = [];
            
            // Handle Explicit 'Random' or standard array logic
            if (!forcedInjuries || forcedInjuries.length === 0) {
                const possible = Object.keys(FrameworkData.injuries).filter(k => FrameworkData.injuries[k].context.includes(context));
                injuryKeys.push(Math.random() > 0.3 ? Utils.choice(possible) : 'Uninjured');
            } else {
                // Process forced array (could contain 'Random' or specific keys)
                forcedInjuries.forEach(val => {
                    if (val === 'Random') {
                        const possible = Object.keys(FrameworkData.injuries).filter(k => k !== 'Uninjured' && FrameworkData.injuries[k].context.includes(context));
                        injuryKeys.push(Utils.choice(possible));
                    } else if (val && val !== 'None') {
                        injuryKeys.push(val);
                    }
                });
            }
            
            // Dedupe
            injuryKeys = [...new Set(injuryKeys)];
            if (injuryKeys.length === 0) injuryKeys.push('Uninjured');

            const injuriesData = injuryKeys.map(k => ({...FrameworkData.injuries[k], key: k}));
            
            // Base Vitals
            let combinedVitals = customVitals ? { ...customVitals } : { ACVPU: 'A', HR: 80, RR: 16, SBP: 120, SpO2: 99, CRT: 2 };
            let combinedDeterioration = {};
            let interventions = {};
            let visualDescriptions = [];
            let entrapmentStatus = 'None';

            // If no custom vitals, calculate from injuries
            if (!customVitals) {
                injuriesData.forEach(inj => {
                    if(inj.visual) visualDescriptions.push(inj.visual);
                    
                    // Worst-case logic for vitals
                    if (ACVPU_SCALE.indexOf(inj.vitals.ACVPU) < ACVPU_SCALE.indexOf(combinedVitals.ACVPU)) combinedVitals.ACVPU = inj.vitals.ACVPU;
                    if (inj.vitals.SBP < combinedVitals.SBP) combinedVitals.SBP = inj.vitals.SBP;
                    if (inj.vitals.SpO2 < combinedVitals.SpO2) combinedVitals.SpO2 = inj.vitals.SpO2;
                    if (inj.vitals.CRT > combinedVitals.CRT) combinedVitals.CRT = inj.vitals.CRT;
                    if (Math.abs(inj.vitals.HR - 80) > Math.abs(combinedVitals.HR - 80)) combinedVitals.HR = inj.vitals.HR;
                    if (Math.abs(inj.vitals.RR - 16) > Math.abs(combinedVitals.RR - 16)) combinedVitals.RR = inj.vitals.RR;

                    Object.entries(inj.deterioration || {}).forEach(([k, v]) => {
                        combinedDeterioration[k] = (combinedDeterioration[k] || 0) + v;
                    });
                    Object.assign(interventions, inj.interventions);
                    
                    if (context === 'rtc' && (inj.type === 'major' || inj.type === 'critical')) entrapmentStatus = 'Physical (Dashboard/Door)';
                    else if (context === 'rtc' && inj.type === 'moderate') entrapmentStatus = 'Medical (Pain/C-Spine)';
                });
            } else {
                // Custom vitals provided, still need interventions/deterioration from injuries
                 injuriesData.forEach(inj => {
                    if(inj.visual) visualDescriptions.push(inj.visual);
                    Object.entries(inj.deterioration || {}).forEach(([k, v]) => {
                        combinedDeterioration[k] = (combinedDeterioration[k] || 0) + v;
                    });
                    Object.assign(interventions, inj.interventions);
                 });
            }

            return {
                id: id,
                age: Utils.randInt(18, 85),
                role: (id === 0) ? 'Driver' : 'Passenger',
                injuries: injuriesData,
                visualDescription: visualDescriptions.join(' ') || "Patient appears stable.",
                vitals: combinedVitals,
                initialVitals: {...combinedVitals},
                deterioration: combinedDeterioration,
                interventions: interventions,
                treatedInjuries: new Set(),
                overrideState: 'normal',
                vitalsHistory: [],
                deteriorationAccumulator: {},
                entrapment: entrapmentStatus,
                ample: {
                    A: Utils.choice(FrameworkData.ample.allergies),
                    M: Utils.choice(FrameworkData.ample.medications),
                    P: Utils.choice(FrameworkData.ample.pastHistory),
                    L: Utils.choice(FrameworkData.ample.lastMeal),
                    E: Utils.choice(FrameworkData.ample.events)
                }
            };
        }

        static createRTC(config) {
            const vehicleCount = parseInt(config.vehicles || 2);
            const patientCount = parseInt(config.patients || 2);
            const vehicles = [];
            const casualties = [];
            const isTJunction = Math.random() > 0.5;
            const vKeys = Object.keys(FrameworkData.vehicles);

            for(let i=0; i<vehicleCount; i++) {
                const type = Utils.choice(vKeys);
                const proto = FrameworkData.vehicles[type];
                let x, y, rotation;
                if (isTJunction) {
                    x = (i===0) ? CONFIG.CANVAS_W * 0.45 : CONFIG.CANVAS_W * 0.55;
                    y = (i===0) ? CONFIG.CANVAS_H * 0.4 : CONFIG.CANVAS_H * 0.6;
                    rotation = (i===0) ? Utils.rand(-10, 10) : Utils.rand(80, 100);
                } else {
                    x = CONFIG.CANVAS_W * (0.35 + i*0.2);
                    y = CONFIG.CANVAS_H * 0.5 + Utils.rand(-20, 20);
                    rotation = Utils.rand(-15, 15);
                }
                vehicles.push({ 
                    id: i, 
                    label: String.fromCharCode(65+i), 
                    ...proto, 
                    x, y, rotation, 
                    color: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b'][i % 4], 
                    damage: (i===0 && isTJunction) ? 'Frontal Impact (Severe)' : 'Side Impact (Intrusion)',
                    position: (Math.random() > 0.8) ? 'On Side' : 'Upright'
                });
            }

            // Generate Casualties
            for(let i=0; i<patientCount; i++) {
                // If custom config exists for this patient, use it
                if (config.customPatients && config.customPatients[i]) {
                    casualties.push(this.createCasualty(i, 'rtc', [config.customPatients[i].injury], config.customPatients[i].vitals));
                } else {
                    casualties.push(this.createCasualty(i, 'rtc', config.presetInjuries));
                }
            }
            
            // GUARANTEED INJURY CHECK
            const anyInjured = casualties.some(c => c.injuries.some(i => i.type !== 'none'));
            if (!anyInjured && casualties.length > 0 && !config.customPatients) {
                const targetIndex = Utils.randInt(0, casualties.length - 1);
                // Force regenerate with a random non-uninjured profile
                casualties[targetIndex] = this.createCasualty(targetIndex, 'rtc', ['Random']); 
            }

            vehicles.forEach((v, idx) => { v.passengers = casualties.filter((_, ci) => ci % vehicles.length === idx); });

            const hazards = [];
            (config.forceHazards || []).forEach(hType => {
                const templ = FrameworkData.hazards.find(h => h.type === hType);
                if(templ) hazards.push({ ...templ, x: Utils.rand(100, CONFIG.CANVAS_W - 100), y: Utils.rand(100, CONFIG.CANVAS_H - 100), rotation: Utils.rand(0, 360) });
            });
            if (Math.random() < (config.hazardProb || 0.5)) {
                const h = FrameworkData.hazards[Math.floor(Math.random()*FrameworkData.hazards.length)];
                hazards.push({ ...h, x: Utils.rand(100, CONFIG.CANVAS_W - 100), y: Utils.rand(100, CONFIG.CANVAS_H - 100), rotation: Utils.rand(0, 360) });
            }

            return { type: 'RTC', title: 'Road Traffic Collision', location: isTJunction ? 'Urban Junction' : 'A-Road', timeLimit: 20, vehicles, casualties, hazards, layout: isTJunction ? 'T-Junction' : 'Head-On' };
        }

        static createTrauma(config) {
            const patientCount = parseInt(config.patients || 2);
            const casualties = [];
            for(let i=0; i<patientCount; i++) {
                 if (config.customPatients && config.customPatients[i]) {
                    casualties.push(this.createCasualty(i, 'trauma', [config.customPatients[i].injury], config.customPatients[i].vitals));
                } else {
                    casualties.push(this.createCasualty(i, 'trauma', config.presetInjuries));
                }
            }
            
            // GUARANTEED INJURY CHECK
            const anyInjured = casualties.some(c => c.injuries.some(i => i.type !== 'none'));
            if (!anyInjured && casualties.length > 0 && !config.customPatients) {
                const targetIndex = Utils.randInt(0, casualties.length - 1);
                casualties[targetIndex] = this.createCasualty(targetIndex, 'trauma', ['Random']);
            }

            const hazards = [];
            (config.forceHazards || []).forEach(hType => {
                const templ = FrameworkData.hazards.find(h => h.type === hType);
                if(templ) hazards.push({ ...templ, x: Utils.rand(100, CONFIG.CANVAS_W - 100), y: Utils.rand(100, CONFIG.CANVAS_H - 100), rotation: Utils.rand(0, 360) });
            });

            return { type: 'Trauma', title: 'Trauma Challenge', location: 'Industrial Estate', timeLimit: 15, vehicles: [], casualties, hazards, layout: 'Open Area' };
        }
    }

    /* ================= RENDERER ================= */
    class Renderer {
        static draw(canvas, scenario) {
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;
            ctx.clearRect(0,0,w,h);
            ctx.save(); ctx.translate(w / 2, h / 2); ctx.scale(1.5, 1.5); ctx.translate(-w / 2, -h / 2);
            
            // Background
            ctx.fillStyle = '#e2e8f0'; ctx.fillRect(0,0,w,h);
            ctx.fillStyle = '#dcfce7'; ctx.fillRect(0,0,w, h*0.1); ctx.fillRect(0,h*0.9,w, h*0.1);
            
            // Road
            ctx.strokeStyle = 'white'; ctx.lineWidth = 4; ctx.setLineDash([20, 20]);
            if (scenario.type === 'RTC') {
                if (scenario.layout === 'T-Junction') {
                    ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(w/2, h/2); ctx.lineTo(w/2, h); ctx.stroke();
                } else {
                    ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); ctx.stroke();
                }
            }
            ctx.setLineDash([]);

            // Objects
            scenario.hazards.forEach(haz => this._drawHazard(ctx, haz));
            scenario.vehicles.forEach(veh => this._drawVehicle(ctx, veh));
            if (scenario.type === 'Trauma') {
                scenario.casualties.forEach((cas, i) => {
                    this._drawCasualty(ctx, w/2 + (i%2===0?50:-50) + Utils.rand(-20,20), h/2 + (Math.floor(i/2)*50) + Utils.rand(-20,20), `C${i+1}`);
                });
            }
            ctx.restore();
        }

        static _drawVehicle(ctx, v) {
            ctx.save(); ctx.translate(v.x, v.y); ctx.rotate((v.rotation * Math.PI) / 180);
            ctx.fillStyle = 'rgba(0,0,0,0.2)'; this._roundRect(ctx, -55, -28, 110, 56, 8, true, false);
            ctx.fillStyle = v.color; ctx.strokeStyle = '#334155'; ctx.lineWidth = 2; this._roundRect(ctx, -50, -25, 100, 50, 6, true, true);
            ctx.fillStyle = '#cbd5e1'; this._roundRect(ctx, -35, -20, 70, 40, 4, true, false);
            ctx.fillStyle = 'rgba(255,255,255,0.8)'; ctx.font = 'bold 20px Inter'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(v.label, 0, 0);
            if(v.isEV) { ctx.fillStyle = '#10b981'; this._roundRect(ctx, -48, -45, 30, 15, 4, true, false); ctx.fillStyle = '#fff'; ctx.font = 'bold 10px Inter'; ctx.fillText('EV', -33, -37); }
            if(v.hasUHSS) { ctx.fillStyle = '#64748b'; this._roundRect(ctx, 18, -45, 30, 15, 4, true, false); ctx.fillStyle = '#fff'; ctx.font = 'bold 8px Inter'; ctx.fillText('UHSS', 33, -37); }
            if(v.passengers) v.passengers.forEach((p, idx) => { ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc((idx % 2 === 0) ? -10 : 10, (idx < 2) ? -10 : 10, 6, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = 'white'; ctx.font='8px Inter'; ctx.fillText(`C${p.id+1}`, (idx % 2 === 0) ? -10 : 10, (idx < 2) ? -10 : 10); });
            ctx.restore();
        }

        static _drawHazard(ctx, h) {
            ctx.save(); ctx.translate(h.x, h.y); ctx.rotate((h.rotation || 0) * Math.PI/180);
            if (h.type.includes('Fire')) { ctx.fillStyle = 'rgba(245, 158, 11, 0.4)'; ctx.beginPath(); ctx.arc(0,0, h.r || 30, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#dc2626'; ctx.font = '24px serif'; ctx.textAlign='center'; ctx.fillText('ðŸ”¥', 0, 8); }
            else if (h.type === 'Fuel Spill') { ctx.fillStyle = 'rgba(59, 130, 246, 0.3)'; ctx.beginPath(); ctx.ellipse(0,0, 60, 30, 0, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#1e3a8a'; ctx.font='10px Inter'; ctx.fillText('Fuel', -10, 0); }
            else if (h.type === 'Wall') { ctx.fillStyle = '#71717a'; ctx.fillRect(-40, -5, 80, 10); }
            else { ctx.fillStyle = '#facc15'; ctx.beginPath(); ctx.moveTo(0, -15); ctx.lineTo(15, 10); ctx.lineTo(-15, 10); ctx.fill(); ctx.fillStyle = 'black'; ctx.font='bold 14px Inter'; ctx.textAlign='center'; ctx.fillText('!', 0, 5); }
            ctx.restore();
        }
        
        static _drawCasualty(ctx, x, y, label) { ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(x, y, 10, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = 'white'; ctx.font='bold 10px Inter'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(label, x, y); }
        static _roundRect(ctx, x, y, w, h, r, fill, stroke) { ctx.beginPath(); ctx.roundRect(x, y, w, h, r); if(fill) ctx.fill(); if(stroke) ctx.stroke(); }
    }

    /* ================= APP CONTROLLER ================= */
    class App {
        constructor() {
            this.state = { view: 'menu', scenario: null, logs: [], simRunning: false, simTime: 0, timers: { sim: null, clock: null } };
            this.charts = {};
            this.render();
        }

        generateScenario(type, config) {
            this.state.scenario = type === 'rtc' ? ScenarioGenerator.createRTC(config) : ScenarioGenerator.createTrauma(config);
            this.state.view = 'setup';
            this.state.logs = [];
            this.addLog('Scenario generated.', 'system');
            this.render();
            setTimeout(() => { const cvs = document.getElementById('setupCanvas'); if(cvs) Renderer.draw(cvs, this.state.scenario); }, 50);
        }

        startSimulation() {
            this.state.view = 'live';
            this.state.simRunning = true;
            this.startTimers();
            this.render(); 
            // Draw canvas again as it was wiped
            setTimeout(() => { const cvs = document.getElementById('setupCanvas'); if(cvs) Renderer.draw(cvs, this.state.scenario); }, 50);
        }

        startTimers() {
            clearInterval(this.state.timers.clock); clearInterval(this.state.timers.sim);
            this.state.timers.clock = setInterval(() => {
                if(!this.state.simRunning) return;
                this.state.simTime++;
                const timerEl = document.getElementById('sim-timer');
                if(timerEl) timerEl.textContent = `${Math.floor(this.state.simTime/60).toString().padStart(2,'0')}:${(this.state.simTime%60).toString().padStart(2,'0')}`;
            }, 1000);
            this.state.timers.sim = setInterval(() => { if(this.state.simRunning) this.tick(); }, 5000);
        }

        togglePause() {
            this.state.simRunning = !this.state.simRunning;
            this.renderLive(document.getElementById('live-container')); // Re-render controls
            this.addLog(this.state.simRunning ? 'Simulation Resumed' : 'Simulation Paused', 'system');
        }

        tick() {
            this.state.scenario.casualties.forEach(cas => {
                cas.vitalsHistory.push({ t: this.state.simTime, ...cas.vitals });
                
                // Arrest State
                if (cas.overrideState === 'arrest') {
                    cas.vitals = { ACVPU: 'U', HR: 0, RR: 0, SBP: 0, SpO2: 0, CRT: 0 };
                    return;
                }
                
                if (cas.overrideState === 'stabilised' || cas.overrideState === 'handed_over') return;

                // PHYSIOLOGICAL LOGIC
                if (cas.vitals.SBP < 60 && ACVPU_SCALE.indexOf(cas.vitals.ACVPU) > ACVPU_SCALE.indexOf('P')) {
                     cas.vitals.ACVPU = 'P';
                     this.addLog(`Casualty ${cas.id+1} consciousness dropped to Pain due to hypotension.`, 'bad');
                }
                if (cas.vitals.SBP < 50 && ACVPU_SCALE.indexOf(cas.vitals.ACVPU) > ACVPU_SCALE.indexOf('U')) {
                     cas.vitals.ACVPU = 'U';
                     this.addLog(`Casualty ${cas.id+1} consciousness dropped to Unresponsive due to severe hypotension.`, 'bad');
                }
                if (cas.vitals.SBP < 40) {
                    cas.overrideState = 'arrest';
                    this.addLog(`Casualty ${cas.id+1} CARDIAC ARREST (Hypovolaemia).`, 'bad');
                    return;
                }

                // SLOW DETERIORATION LOGIC
                if (Math.random() < 0.15) { 
                    const allTreated = cas.injuries.every(i => cas.treatedInjuries.has(i.key));
                    if (!allTreated) {
                        Object.entries(cas.deterioration).forEach(([k, delta]) => {
                            if (!cas.deteriorationAccumulator[k]) cas.deteriorationAccumulator[k] = 0;
                            cas.deteriorationAccumulator[k] += delta;

                            if (Math.abs(cas.deteriorationAccumulator[k]) >= 1) {
                                const change = Math.trunc(cas.deteriorationAccumulator[k]);
                                cas.deteriorationAccumulator[k] -= change;
                                
                                if (k === 'ACVPU') {
                                    const idx = ACVPU_SCALE.indexOf(cas.vitals.ACVPU);
                                    const newIdx = Utils.clamp(idx + change, 0, 4);
                                    cas.vitals.ACVPU = ACVPU_SCALE[newIdx];
                                } else {
                                    cas.vitals[k] = Math.max(0, Math.round(cas.vitals[k] + change));
                                }
                            }
                        });
                        this.addLog(`Casualty ${cas.id+1} vital signs changing.`, 'bad');
                    }
                }

                if(Math.random() > 0.7) cas.vitals.HR += (Math.random()>0.5?1:-1);
                
                if (cas.vitals.HR > 210) {
                    cas.vitals.HR = 210;
                    this.addLog(`Casualty ${cas.id+1} Tachycardia Critical (HR 210).`, 'bad');
                }
            });
            this.updateLiveVitals();
        }

        applyIntervention(casId, injKey, intKey, btn) {
            const cas = this.state.scenario.casualties.find(c => c.id == casId);
            const inj = cas.injuries.find(i => i.key === injKey);
            const action = inj.interventions[intKey];
            Object.entries(action.effect || {}).forEach(([k,v]) => {
                if (typeof v === 'number') cas.vitals[k] += v;
            });
            if (action.stopsDeterioration) cas.treatedInjuries.add(injKey);
            this.addLog(`C${parseInt(casId)+1}: ${action.feedback}`, 'good');
            if(btn) { btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed'); btn.innerHTML = `<i class="fa-solid fa-check mr-1"></i> Done`; }
        }
        
        toggleArrest(casId) {
            const cas = this.state.scenario.casualties.find(c => c.id == casId);
            if (cas.overrideState === 'arrest') {
                cas.overrideState = 'normal';
                cas.vitals = { ...cas.initialVitals, HR: 90, SBP: 100 };
                this.addLog(`C${parseInt(casId)+1}: ROSC Achieved.`, 'good');
            } else {
                cas.overrideState = 'arrest';
                this.addLog(`C${parseInt(casId)+1}: CARDIAC ARREST CONFIRMED.`, 'bad');
            }
            this.renderLive(document.getElementById('live-container'));
        }
        
        triggerEvent(type, casId = null) {
            let msg = `Dynamic Event: ${type} triggered`;
            if (casId !== null) {
                msg += ` for Casualty ${casId+1}`;
                const cas = this.state.scenario.casualties.find(c => c.id == casId);
                if (type === 'Seizure') {
                    cas.vitals.ACVPU = 'U';
                    cas.vitals.HR = 140;
                    cas.vitals.SpO2 = 85;
                    setTimeout(() => { 
                        cas.vitals.HR = 110; 
                        cas.vitals.SpO2 = 92; 
                        this.addLog(`C${casId+1}: Seizure activity ceasing. Post-ictal.`, 'info'); 
                    }, 15000); 
                }
                if (type === 'Agitated') {
                    cas.vitals.HR += 20;
                    cas.vitals.RR += 10;
                }
            }
            this.addLog(msg, 'bad');
        }

        logAction(casId, actionText) { this.addLog(`C${parseInt(casId)+1}: ${actionText}`, 'good'); }
        addLog(msg, type='info') {
            const time = new Date().toLocaleTimeString('en-GB', { hour12: false });
            this.state.logs.push({ time, msg, type });
            const logBox = document.getElementById('log-container');
            if (logBox) {
                const color = type==='good'?'text-green-600':type==='bad'?'text-red-600':type==='command'?'text-amber-600':'text-gray-600';
                const div = document.createElement('div');
                div.className = `text-sm py-1 border-b border-gray-100 ${color}`;
                div.innerHTML = `<span class="text-xs text-gray-400 font-mono mr-2">[${time}]</span> ${msg}`;
                logBox.prepend(div);
            }
        }

        switchCasTab(casId, tabName) {
            document.querySelectorAll(`#cas-card-${casId} .inner-tab-content`).forEach(el => {
                el.classList.remove('active');
                el.style.display = 'none';
            });
            const target = document.getElementById(`cas-tab-${casId}-${tabName}`);
            target.style.display = 'block';
            setTimeout(()=>target.classList.add('active'), 10);
            
            document.querySelectorAll(`#cas-card-${casId} .inner-tab-btn`).forEach(el => el.classList.remove('active'));
            document.querySelector(`#cas-card-${casId} [data-tab="${tabName}"]`).classList.add('active');
        }

        // CUSTOM MODE LOGIC
        updateCustomPatient(index, injury) {
            if (!injury || injury === 'Uninjured') {
                this.customConfig.patients[index] = { injury: 'Uninjured', vitals: { ACVPU: 'A', HR: 80, RR: 16, SBP: 120, SpO2: 99, CRT: 2 } };
            } else {
                const template = FrameworkData.injuries[injury];
                this.customConfig.patients[index] = { injury: injury, vitals: { ...template.vitals } };
            }
            this.renderCustomSetup();
        }
        
        updateCustomVital(index, key, value) {
            if (this.customConfig.patients[index]) {
                this.customConfig.patients[index].vitals[key] = value;
            }
        }

        /* ================= UI RENDERERS ================= */
        render() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            if (this.state.view === 'menu') this.renderMenu(app);
            else if (this.state.view === 'custom') this.renderCustomSetup(app);
            else if (this.state.view === 'setup') this.renderSetup(app);
            else if (this.state.view === 'live') {
                this.renderSetup(app); // Briefing visible
                const startBtn = app.querySelector('#startBtnContainer');
                if(startBtn) startBtn.style.display = 'none';
                
                const liveContainer = document.createElement('div');
                liveContainer.id = 'live-container';
                liveContainer.className = 'mt-8 pt-8 border-t-4 border-gray-300';
                app.appendChild(liveContainer);
                this.renderLive(liveContainer);
            }
        }

        renderMenu(container) {
            container.innerHTML = `
            <div class="max-w-4xl mx-auto space-y-8 animate-fade-in">
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-gray-800">Select Scenario</h2>
                    <p class="text-gray-500">Choose a template or build a custom scenario.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-600 cursor-pointer hover:shadow-xl transition" onclick="const el = document.getElementById('rtc-opts'); if(el) el.classList.remove('hidden')">
                        <h3 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-car-burst mr-2"></i>RTC Random</h3>
                        <p class="text-sm text-gray-600 mt-2">Road traffic collisions involving cars, heavy goods vehicles, or EVs. Includes entrapment and scene hazards.</p>
                        <div id="rtc-opts" class="hidden mt-4 space-y-3">
                            <select id="rtc-v" class="w-full border p-2 rounded text-sm"><option value="1">1 Vehicle</option><option value="2" selected>2 Vehicles</option><option value="3">3 Vehicles</option></select>
                            <select id="rtc-p" class="w-full border p-2 rounded text-sm"><option value="1">1 Patient</option><option value="2" selected>2 Patients</option><option value="3">3 Patients</option></select>
                            <button onclick="event.stopPropagation(); app.generateScenario('rtc', {vehicles: document.getElementById('rtc-v').value, patients: document.getElementById('rtc-p').value})" class="btn btn-primary w-full py-2 rounded">Generate</button>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-red-600 cursor-pointer hover:shadow-xl transition" onclick="const el = document.getElementById('trauma-opts'); if(el) el.classList.remove('hidden')">
                        <h3 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-user-injured mr-2"></i>Trauma Random</h3>
                        <p class="text-sm text-gray-600 mt-2">Industrial accidents, falls from height, or medical emergencies in complex environments.</p>
                         <div id="trauma-opts" class="hidden mt-4 space-y-3">
                            <select id="trauma-p" class="w-full border p-2 rounded text-sm"><option value="1">1 Patient</option><option value="2" selected>2 Patients</option></select>
                            <button onclick="event.stopPropagation(); app.generateScenario('trauma', {patients: document.getElementById('trauma-p').value})" class="btn btn-secondary w-full py-2 rounded">Generate</button>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-amber-500 cursor-pointer hover:shadow-xl transition" onclick="app.customConfig = {type:'rtc', patients:[]}; app.state.view='custom'; app.render();">
                        <h3 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-sliders mr-2"></i>Custom Setup</h3>
                        <p class="text-sm text-gray-600 mt-2">Manually configure patient numbers, specific injuries, and initial vital signs.</p>
                    </div>
                </div>
            </div>`;
        }

        renderCustomSetup(container) {
            // Initialize if needed
            if (!this.customConfig.patients.length) {
                this.customConfig.patients = [{ injury: 'Uninjured', vitals: { ACVPU: 'A', HR: 80, RR: 16, SBP: 120, SpO2: 99, CRT: 2 } }];
            }
            
            const injuries = Object.keys(FrameworkData.injuries);
            const app = document.getElementById('app'); // Ensure we target app div
            
            app.innerHTML = `
            <div class="bg-white p-6 rounded-xl shadow-lg space-y-6 max-w-5xl mx-auto animate-fade-in">
                <div class="flex justify-between items-center border-b pb-4">
                    <h2 class="text-2xl font-bold text-gray-900">Custom Scenario Builder</h2>
                    <button onclick="app.state.view='menu'; app.render()" class="btn btn-ghost px-4 py-2 rounded">Back</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700">Scenario Type</label>
                        <select onchange="app.customConfig.type = this.value" class="w-full border p-2 rounded mb-4">
                            <option value="rtc">RTC</option>
                            <option value="trauma">Trauma</option>
                        </select>
                        
                        <label class="block text-sm font-bold text-gray-700">Patient Count</label>
                        <input type="number" min="1" max="5" value="${this.customConfig.patients.length}" 
                            onchange="const newCount = parseInt(this.value); 
                                      if(newCount > app.customConfig.patients.length) {
                                          for(let i=app.customConfig.patients.length; i<newCount; i++) app.updateCustomPatient(i, 'Uninjured');
                                      } else {
                                          app.customConfig.patients = app.customConfig.patients.slice(0, newCount);
                                          app.renderCustomSetup();
                                      }" 
                            class="w-full border p-2 rounded mb-4">
                    </div>
                    
                    <div class="space-y-2">
                        <label class="block text-sm font-bold text-gray-700">Hazards</label>
                        <div class="flex flex-wrap gap-2">
                            ${FrameworkData.hazards.map(h => `<label class="inline-flex items-center text-xs bg-gray-50 px-2 py-1 rounded border"><input type="checkbox" class="custom-hazard" value="${h.type}"> ${h.type}</label>`).join('')}
                        </div>
                    </div>
                </div>

                <div class="space-y-4 border-t pt-4">
                    <h3 class="font-bold text-lg">Patient Configuration</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        ${this.customConfig.patients.map((p, i) => `
                            <div class="border rounded-xl p-4 bg-gray-50">
                                <h4 class="font-bold text-sm mb-2">Patient ${i+1}</h4>
                                <select onchange="app.updateCustomPatient(${i}, this.value)" class="w-full border p-1 rounded text-sm mb-3 bg-white">
                                    ${injuries.map(inj => `<option value="${inj}" ${p.injury === inj ? 'selected' : ''}>${inj}</option>`).join('')}
                                </select>
                                
                                <div class="grid grid-cols-3 gap-2 text-xs">
                                    <div><label>HR</label><input type="number" value="${p.vitals.HR}" onchange="app.updateCustomVital(${i}, 'HR', parseInt(this.value))" class="w-full border rounded p-1"></div>
                                    <div><label>RR</label><input type="number" value="${p.vitals.RR}" onchange="app.updateCustomVital(${i}, 'RR', parseInt(this.value))" class="w-full border rounded p-1"></div>
                                    <div><label>SBP</label><input type="number" value="${p.vitals.SBP}" onchange="app.updateCustomVital(${i}, 'SBP', parseInt(this.value))" class="w-full border rounded p-1"></div>
                                    <div><label>SpO2</label><input type="number" value="${p.vitals.SpO2}" onchange="app.updateCustomVital(${i}, 'SpO2', parseInt(this.value))" class="w-full border rounded p-1"></div>
                                    <div><label>ACVPU</label><select onchange="app.updateCustomVital(${i}, 'ACVPU', this.value)" class="w-full border rounded p-1"><option>${p.vitals.ACVPU}</option><option>A</option><option>C</option><option>V</option><option>P</option><option>U</option></select></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <button onclick="app.generateScenario(app.customConfig.type, { customPatients: app.customConfig.patients, forceHazards: [...document.querySelectorAll('.custom-hazard:checked')].map(c=>c.value) })" class="btn btn-primary w-full py-3 text-lg font-bold rounded shadow-lg">Launch Custom Scenario</button>
            </div>`;
        }

        renderSetup(container) {
            const s = this.state.scenario;
            container.innerHTML = `
            <div class="space-y-6 animate-fade-in">
                <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                    <div><h2 class="text-2xl font-bold text-gray-900">Instructor Briefing</h2><p class="text-sm text-gray-500">Location: ${s.location} | Time Limit: ${s.timeLimit} mins</p></div>
                    <div id="startBtnContainer" class="flex gap-2">
                        <button onclick="window.print()" class="btn btn-ghost px-4 py-2 rounded">Print</button>
                        <button onclick="app.startSimulation()" class="btn btn-primary px-6 py-2 rounded font-bold">Start Simulation</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-1 rounded-xl shadow border border-gray-200">
                        <canvas id="setupCanvas" width="${CONFIG.CANVAS_W}" height="${CONFIG.CANVAS_H}" class="w-full h-auto bg-gray-50"></canvas>
                    </div>
                    <div class="space-y-4">
                        ${s.casualties.map((c, i) => `<div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500"><h4 class="font-bold">Casualty ${i+1} (${c.age} yrs)</h4><p class="text-sm mt-1 text-gray-600">${c.injuries.map(j => j.name).join(', ')}</p><div class="text-xs bg-gray-100 p-2 mt-2 rounded font-mono">GCS:${c.vitals.ACVPU} HR:${c.vitals.HR} RR:${c.vitals.RR} BP:${c.vitals.SBP}</div><div class="text-xs mt-1 text-amber-700 font-bold">Entrapment: ${c.entrapment}</div></div>`).join('')}
                         <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200"><h4 class="font-bold text-sm">Hazards</h4><p class="text-sm text-amber-600">${s.hazards.map(h=>h.type).join(', ') || 'None'}</p></div>
                    </div>
                </div>
            </div>`;
        }

        renderLive(container) {
            const actionButton = (label, color, type, dataAttrs = '') => `<button class="${type}-btn bg-${color}-600 hover:bg-${color}-700 text-white text-xs font-bold py-1 px-2 rounded shadow-sm" ${dataAttrs}>${label}</button>`;
            const actionGroup = (title, actions, color, type, casId = null) => `<div class="mb-2"><p class="text-[10px] font-bold text-gray-500 uppercase tracking-wide mb-1">${title}</p><div class="flex flex-wrap gap-1">${actions.map(act => actionButton(act, color, type, `data-action="${act}"` + (casId !== null ? ` data-casualty-id="${casId}"` : ''))).join('')}</div></div>`;

            container.innerHTML = `
            <div class="flex flex-col gap-4 animate-fade-in">
                <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center sticky top-0 z-10">
                    <div class="flex items-center gap-4">
                        <div class="bg-gray-900 text-red-500 font-mono text-2xl px-4 py-1 rounded font-bold" id="sim-timer">00:00</div>
                        <button onclick="app.togglePause()" class="btn ${this.state.simRunning ? 'btn-secondary' : 'btn-primary'} px-4 py-2 rounded">${this.state.simRunning ? 'Pause' : 'Resume'}</button>
                    </div>
                    <button onclick="alert('Simulation Ended. Debrief mode not in this demo.')" class="btn btn-tertiary px-4 py-2 rounded">Finish</button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="font-bold text-gray-700 text-sm mb-2 border-b pb-2">Scene & Global Actions</h3>
                            ${actionGroup('Scene Markers', ['360 Survey', 'Stabilisation Complete', 'Glass Managed', 'Access Plan Agreed', 'Space Created', 'Full Access'], 'amber', 'scenario-action')}
                            <div class="mt-4 border-t pt-2">
                                <h4 class="text-xs font-bold text-red-600 mb-2">Dynamic Triggers</h4>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="app.triggerEvent('New Fire')" class="text-xs border border-red-200 text-red-700 rounded p-1 hover:bg-red-50">Fire Starts</button>
                                    <button onclick="app.triggerEvent('Fuel Spill')" class="text-xs border border-blue-200 text-blue-700 rounded p-1 hover:bg-blue-50">Fuel Leak</button>
                                    ${this.state.scenario.casualties.map(c => `<button onclick="app.triggerEvent('Seizure', ${c.id})" class="text-xs border border-purple-200 text-purple-700 rounded p-1 hover:bg-purple-50">C${c.id+1} Seizure</button>`).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-col h-64">
                            <h3 class="font-bold text-gray-700 text-sm mb-2">Incident Log</h3>
                            <div id="log-container" class="flex-grow overflow-y-auto custom-scroll bg-gray-50 p-2 rounded border border-gray-100 font-mono text-xs flex flex-col-reverse"></div>
                            <div class="mt-2 flex gap-1"><input id="manualLog" class="flex-grow border rounded px-2 text-sm"><button onclick="app.addLog(document.getElementById('manualLog').value, 'command');" class="btn btn-primary px-2 text-xs">Add</button></div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${this.state.scenario.casualties.map(c => this.renderCasualtyCard(c)).join('')}
                    </div>
                </div>
            </div>`;
            this.state.logs.forEach(l => this.addLog(l.msg, l.type));
        }

        renderCasualtyCard(c) {
            const btnClass = "text-left text-xs p-2 bg-gray-50 border rounded hover:bg-blue-50 hover:border-blue-200 hover:text-blue-700 transition";
            const genBtns = (list) => list.map(a => `<button onclick="app.logAction(${c.id}, '${a}')" class="${btnClass}">${a}</button>`).join('');
            
            // ROSC vs ARREST Button logic
            let arrestBtnHtml = '';
            if (c.overrideState === 'arrest') {
                arrestBtnHtml = `<button onclick="app.toggleArrest(${c.id})" class="text-xs border border-green-600 bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 shadow-md animate-pulse font-bold">ROSC</button>`;
            } else {
                arrestBtnHtml = `<button onclick="app.toggleArrest(${c.id})" class="text-xs border border-red-200 text-red-700 px-2 py-1 rounded hover:bg-red-50">Arrest</button>`;
            }

            return `
            <div id="cas-card-${c.id}" class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col">
                <div class="bg-gray-50 p-3 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="font-bold text-gray-800">Casualty ${c.id+1}</h3>
                    <div class="flex gap-1">
                        ${arrestBtnHtml}
                        <button class="text-xs border border-blue-200 text-blue-700 px-2 py-1 rounded hover:bg-blue-50">Handover</button>
                    </div>
                </div>
                <div class="p-4 space-y-3 flex-grow">
                    <div class="text-xs text-gray-500 italic bg-yellow-50 p-2 rounded border border-yellow-100">${c.visualDescription}</div>
                    <div id="vitals-${c.id}" class="bg-gray-900 text-green-400 font-mono p-3 rounded text-center text-sm">Loading Vitals...</div>
                    <div class="flex border-b border-gray-200 gap-2">
                        <button class="inner-tab-btn active" data-tab="primary" onclick="app.switchCasTab(${c.id}, 'primary')">Primary Survey</button>
                        <button class="inner-tab-btn" data-tab="drugs" onclick="app.switchCasTab(${c.id}, 'drugs')">Drugs</button>
                    </div>
                    <!-- COMBINED PRIMARY SURVEY TAB (A, B, C, D, E) -->
                    <div id="cas-tab-${c.id}-primary" class="inner-tab-content active space-y-2">
                        <div><p class="text-xs font-bold text-gray-400">Airway</p><div class="grid grid-cols-2 gap-1">${genBtns(FrameworkData.actions.Airway)}</div></div>
                        <div><p class="text-xs font-bold text-gray-400">Breathing</p><div class="grid grid-cols-2 gap-1">${genBtns(FrameworkData.actions.Breathing)}</div></div>
                        <div><p class="text-xs font-bold text-gray-400">Circulation</p><div class="grid grid-cols-2 gap-1">${genBtns(FrameworkData.actions.Circulation)}</div></div>
                        <div><p class="text-xs font-bold text-gray-400">Disability</p><div class="grid grid-cols-2 gap-1">${genBtns(FrameworkData.actions.Disability)}</div></div>
                        <div><p class="text-xs font-bold text-gray-400">Exposure</p><div class="grid grid-cols-2 gap-1">${genBtns(FrameworkData.actions.Exposure)}</div></div>
                    </div>
                    <div id="cas-tab-${c.id}-drugs" class="inner-tab-content hidden space-y-2">
                        <div class="grid grid-cols-2 gap-1">${genBtns(FrameworkData.actions.Drugs)}</div>
                    </div>
                </div>
            </div>`;
        }

        updateLiveVitals() {
            this.state.scenario.casualties.forEach(c => {
                const el = document.getElementById(`vitals-${c.id}`);
                if(!el) return;
                const v = c.vitals;
                
                // ARREST DISPLAY LOGIC
                if (c.overrideState === 'arrest') {
                    el.innerHTML = `
                    <div class="grid grid-cols-3 gap-y-2 text-red-500">
                        <div><span class="text-gray-500 block text-[10px]">ACVPU</span>U</div>
                        <div><span class="text-gray-500 block text-[10px]">HR</span><span class="font-bold border border-red-600 px-1 rounded bg-red-900/50">ARREST</span></div>
                        <div><span class="text-gray-500 block text-[10px]">RR</span>0</div>
                        <div><span class="text-gray-500 block text-[10px]">BP</span>0/0</div>
                        <div><span class="text-gray-500 block text-[10px]">SpO2</span>0%</div>
                        <div><span class="text-gray-500 block text-[10px]">CRT</span>-</div>
                    </div>`;
                } else {
                    el.innerHTML = `
                    <div class="grid grid-cols-3 gap-y-2">
                        <div><span class="text-xs text-gray-500 block">ACVPU</span>${v.ACVPU}</div>
                        <div><span class="text-xs text-gray-500 block">HR</span>${v.HR}</div>
                        <div><span class="text-xs text-gray-500 block">RR</span>${v.RR}</div>
                        <div><span class="text-xs text-gray-500 block">BP</span>${v.SBP}/${Math.round(v.SBP*0.66)}</div>
                        <div><span class="text-xs text-gray-500 block">SpO2</span>${v.SpO2}%</div>
                        <div><span class="text-xs text-gray-500 block">CRT</span>${v.CRT}s</div>
                    </div>`;
                }
            });
        }
    }

    const app = new App();
  </script>
</body>
</html>
