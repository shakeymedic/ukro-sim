<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UKRO High-Fidelity Scenario Simulator (Instructor)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>


  <style>
    :root{
      --ukro-blue:#0033A0;
      --ukro-red:#C8102E;
      --ukro-navy:#001B44;
      --muted:#6B7280;
      --border:#dee2e6; /* light grey border */
      --focus:#01216922;
      --background-light: #f8f9fa; /* very light grey background */
      --text-dark: #212529; /* dark text */
      --card-bg: #ffffff; /* white card background */
    }
    body { font-family: 'Inter', sans-serif; background-color: var(--background-light); color: var(--text-dark); }
    /* Header */
    .ukro-header{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, #ffffff, #f8f9fa);color: var(--text-dark);
    }
    .ukro-brand{display:flex;gap:12px;align-items:center}
    .ukro-logo{height:40px;width:auto;border-radius:6px;background:#fff}
    .ukro-logo--clear{background:transparent}
    .ukro-brand-title{font-weight:700}
    .ukro-brand-sub{font-size:12px;opacity:.9}
    .ukro-actions{display:flex;gap:10px;align-items:center}
    /* Buttons recoloured to UKRO palette */
    .btn { border-bottom-width: 4px; transition: all 0.1s ease-in-out; }
    .btn:hover { transform: translateY(-2px); }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background-color: var(--ukro-blue); border-color: #00246f; color:#fff; }
    .btn-primary:hover { background-color: #0a45c0; }
    .btn-secondary { background-color: var(--ukro-red); border-color: #8f0d22; color:#fff; }
    .btn-secondary:hover { background-color: #e01f3b; }
    .btn-tertiary { background-color: #f59e0b; border-color: #b45309; color:#111; }
    .btn-tertiary:hover { background-color: #fbbf24; }
    .btn-ghost { background:#fff;color:var(--ukro-blue);border:1px solid #e5e7eb;border-bottom-width:4px }
    .btn-ghost:focus{outline:2px solid var(--focus);outline-offset:2px}
    .chip { display:inline-block; padding:0.1rem 0.5rem; border-radius:9999px; font-size:0.75rem; }
    .chip-ev { background:#d1e7dd; color:#0f5132; }
    .chip-uhss { background:#e2e3e5; color:#41464b; }

    /* Flash red animation when a casualty deteriorates */
    .flash-red {
      animation: flash-red 1.5s ease-in-out;
      border: 2px solid rgba(239, 68, 68, 1);
      box-shadow: 0 0 8px 4px rgba(239, 68, 68, 0.6);
      background-color: rgba(239, 68, 68, 0.12);
    }
    @keyframes flash-red {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
        border-color: rgba(239, 68, 68, 0.8);
        background-color: transparent;
      }
      50% {
        box-shadow: 0 0 20px 6px rgba(239, 68, 68, 0.9);
        border-color: rgba(239, 68, 68, 1);
        background-color: rgba(239, 68, 68, 0.15);
      }
    }

    /* Light theme adjustments for generated elements */
    #main-menu, #setup-screen, #live-sim, #debrief-screen {
        background-color: var(--card-bg);
        border: 1px solid var(--border);
    }
    .bg-gray-900 { /* This class was used for cards */
        background-color: #f8f9fa; /* light grey */
        border: 1px solid var(--border);
    }
    .bg-gray-800 { /* This class was used for main containers */
        background-color: var(--card-bg);
        border: 1px solid var(--border);
    }
    .bg-black { /* This was used for vitals box */
        background-color: #e9ecef; /* slightly darker grey */
    }
    input, select {
      background-color: #e9ecef !important;
      border-color: var(--border) !important;
      color: var(--text-dark) !important;
    }
    .text-white, .text-gray-200, .text-gray-300, .text-gray-400 {
        color: var(--text-dark) !important;
    }
    .border-gray-700 {
        border-color: var(--border) !important;
    }
    h1, h2, h3, h4, strong {
        color: #001B44 !important; /* UKRO Navy */
    }
    .override-btn.active {
        filter: brightness(1.2) saturate(1.5);
        transform: translateY(-2px);
        box-shadow: 0 0 10px 2px var(--color);
    }
    .tab-btn {
        background-color: #e9ecef;
        border-color: #dee2e6;
        border-bottom-width: 1px;
    }
    .tab-btn.active {
        background-color: var(--ukro-blue);
        color: white;
        border-color: #00246f;
        border-bottom-width: 4px;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }


    @media print {
      body { background-color: white; color: black; }
      #main-menu, #controls, #startSimBtn, header.ukro-header, footer { display: none !important; }
      #setup-screen { display: block !important; box-shadow: none; border: none; padding: 0; }
      .bg-gray-800, .bg-gray-900 { background-color: #f3f4f6; border: 1px solid #d1d5db; }
      .text-white { color: black !important; }
      canvas { border: 1px solid #ccc; }
    }
  </style>
</head>

<body class="text-gray-800">
  <header class="ukro-header" role="banner" aria-label="Branding">
    <div class="ukro-brand">
      <img src="images/wmebem-logo.png" alt="WMEBEM logo" class="ukro-logo" />
      <div>
        <div class="ukro-brand-title">UKRO Simulation</div>
        <div class="ukro-brand-sub">West Midlands Evidence-Based Emergency Medicine</div>
      </div>
    </div>
    <div class="ukro-actions">
      <button class="btn btn-ghost" onclick="showUStepOut()">U-STEP-OUT</button>
      <img src="images/UKRO logo.png" alt="UKRO logo" class="ukro-logo ukro-logo--clear" />
    </div>
  </header>

  <div class="w-full max-w-7xl mx-auto p-4">
    <header class="text-center mb-6">
      <h1 class="text-3xl md:text-4xl font-bold">UKRO High-Fidelity Scenario Simulator</h1>
      <p class="text-lg text-gray-600 mt-2">Instructor Control Panel</p>
    </header>

    <div id="app" class="w-full"></div>

    <footer class="text-center mt-8 py-6 border-t border-gray-300 text-gray-500 text-sm">
      <p>Developed by Dr Jake Turner for West Midlands Evidence Based Emergency Medicine Ltd.</p>
      <p>Feedback: <a href="mailto:Jaketurner2503@gmail.com?subject=UKRO%20Simulator%20Feedback" class="text-blue-600 hover:underline">Email Us</a></p>
      <p class="mt-2">Licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" class="text-blue-600 hover:underline">CC BY-NC-SA 4.0</a></p>
    </footer>
  </div>

  <dialog id="ustepout-modal" style="border:none;border-radius:14px;padding:0">
    <form method="dialog" style="min-width:min(800px,95vw);border:1px solid #e5e7eb;border-radius:14px;background:#fff">
      <header style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #e5e7eb">
        <h3 style="margin:0">U-STEP-OUT â€” EXIT Project</h3>
        <button value="close" style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px 12px;cursor:pointer">Close</button>
      </header>
      <div style="padding:12px 14px">
          <img src="images/ustepout.png" alt="U-STEP OUT guide" style="width: 100%; height: auto;"/>
      </div>
    </form>
  </dialog>

  <script>
// js/main.js
(function() {
    // js/config.js
    const CANVAS_W = 900;
    const CANVAS_H = 520;

    // js/data.js
    const frameworkData = {
      scoresheets: {
        command: ['Scene assessment & survey', 'Formulation of tactical plan', 'Clear communication', 'Dynamic risk assessment', 'Scene safety', 'Crew resource management'],
        technical: ['Vehicle stabilisation', 'Glass management', 'Use of hydraulic tools', 'Extrication pathway', 'Vehicle hazards (UHSS, EV)'],
        trauma: ['Scene safety & approach', '<C>ABCDE assessment', 'Identify/manage life-threats', 'Teamwork & communication', 'Ongoing reassessment', 'ATMIST handover']
      },
      injuries: {
        'Tension Pneumothorax': {
          name: 'Tension Pneumothorax', type: 'major', canSelfExtricate: false, bodyPart: 'chest_left', marker: 'T',
          moulage: 'Distended neck veins, hyper-resonant chest, tracheal deviation (late).',
          briefing: 'Extreme shortness of breath, cannot complete sentences.',
          vitals: { GCS: 14, HR: 135, RR: 38, SBP: 85, SpO2: 82, CRT: 4 },
          deterioration: { SpO2: -4, SBP: -5, HR: 5, CRT: 1 },
          interventions: { 'Needle Decompression': { key: 'Needle Decompression', effect: { SpO2: 10, SBP: 10, RR: -8 }, stopsDeterioration: true, feedback: 'Needle decompression performed, releasing pressure.' } }
        },
        'Catastrophic Haemorrhage (Thigh)': {
          name: 'Catastrophic Haemorrhage (Thigh)', type: 'major', canSelfExtricate: false, bodyPart: 'leg_right', marker: 'C',
          moulage: 'Pulsatile bleed, clothing soaked.',
          briefing: 'Pale, clammy, very anxious.',
          vitals: { GCS: 13, HR: 140, RR: 30, SBP: 80, SpO2: 92, CRT: 4 },
          deterioration: { SBP: -8, HR: 6, GCS: -1, CRT: 1 },
          interventions: { 'Apply Tourniquet': { key: 'Apply Tourniquet', effect: { SBP: 15, HR: -20 }, stopsDeterioration: true, feedback: 'Tourniquet applied. Haemorrhage controlled.' } }
        },
        'Severe Head Injury': {
          name: 'Severe Head Injury', type: 'major', canSelfExtricate: false, bodyPart: 'head', marker: 'H',
          moulage: 'Laceration to forehead, one pupil dilated.',
          briefing: 'GCS 8 (E2, V2, M4). Moans to pain.',
          vitals: { GCS: 8, HR: 55, RR: 26, SBP: 180, SpO2: 95, CRT: 2 },
          deterioration: { GCS: -1, RR: -2 },
          interventions: { 'Airway Management': { key: 'Airway Management', effect: { RR: 2, SpO2: 2 }, stopsDeterioration: true, feedback: 'Airway manoeuvre performed, halting deterioration.' } }
        },
        'Lateral Flail Chest': {
          name: 'Lateral Flail Chest', type: 'major', canSelfExtricate: false, bodyPart: 'chest_left', marker: 'F',
          moulage: 'Bruising over left chest, paradoxical movement.',
          briefing: 'Shallow, slow breathing; becoming unresponsive.',
          vitals: { GCS: 7, HR: 130, RR: 6, SBP: 90, SpO2: 86, CRT: 3 },
          deterioration: { SpO2: -5, RR: -1, GCS: -1 },
          interventions: { 'Positive Pressure Ventilation': { key: 'Positive Pressure Ventilation', effect: { SpO2: 8, RR: 6 }, stopsDeterioration: true, feedback: 'PPV initiated, assisting breathing.' } }
        },
        'Unstable Pelvic Fracture': {
          name: 'Unstable Pelvic Fracture', type: 'major', canSelfExtricate: false, bodyPart: 'pelvis', marker: 'P',
          moulage: 'Bruising over pelvic wings, leg length discrepancy.',
          briefing: 'Severe pelvic pain, distressed.',
          vitals: { GCS: 13, HR: 130, RR: 28, SBP: 80, SpO2: 92, CRT: 4 },
          deterioration: { SBP: -10, HR: 8, CRT: 1 },
          interventions: { 'Apply Pelvic Binder': { key: 'Apply Pelvic Binder', effect: { SBP: 10 }, stopsDeterioration: true, feedback: 'Pelvic binder applied, providing stability.' } }
        },
        'Open Femur Fracture': {
          name: 'Open Femur Fracture', type: 'major', canSelfExtricate: false, bodyPart: 'leg_left', marker: 'OF',
          moulage: 'Bone visible through wound, heavy bleeding.',
          briefing: 'Screaming in pain, bleeding heavily.',
          vitals: { GCS: 15, HR: 120, RR: 28, SBP: 95, SpO2: 96, CRT: 3 },
          deterioration: { HR: 5, SBP: -5, CRT: 1 },
          interventions: { 'Apply Traction Splint': { key: 'Apply Traction Splint', effect: { SBP: 10, HR: -15 }, stopsDeterioration: true, feedback: 'Splint applied and haemorrhage controlled.' } }
        },
        'Asthmatic Exacerbation': {
          name: 'Asthmatic Exacerbation', type: 'moderate', canSelfExtricate: true, bodyPart: 'chest_centre', marker: 'A',
          moulage: 'Wheeze audible, accessory muscle use.',
          briefing: 'History of asthma, struggling to speak.',
          vitals: { GCS: 15, HR: 110, RR: 32, SBP: 130, SpO2: 89, CRT: 2 },
          deterioration: { SpO2: -2, RR: 2 },
          interventions: { 'Administer Nebuliser': { key: 'Administer Nebuliser', effect: { SpO2: 5, RR: -6 }, stopsDeterioration: true, feedback: 'Bronchodilator administered, easing breathing.' } }
        },
        'Severe Laceration (Forearm)': {
          name: 'Severe Laceration (Forearm)', type: 'minor', canSelfExtricate: true, bodyPart: 'arm_left', marker: 'W',
          moulage: 'Deep laceration to forearm, steady dark red flow.',
          briefing: 'Alert but in pain, worried about bleeding.',
          vitals: { GCS: 15, HR: 100, RR: 20, SBP: 115, SpO2: 98, CRT: 2 },
          deterioration: { HR: 2 },
          interventions: { 'Apply Wound Dressing': { key: 'Apply Wound Dressing', effect: { HR: -10 }, stopsDeterioration: true, feedback: 'Dressing applied. Bleeding controlled.' } }
        },
        'Wrist Fracture': {
          name: 'Wrist Fracture', type: 'minor', canSelfExtricate: true, bodyPart: 'arm_right', marker: '#',
          moulage: 'Visible deformity to wrist ("dinner fork").',
          briefing: 'Severe wrist pain.',
          vitals: { GCS: 15, HR: 95, RR: 18, SBP: 125, SpO2: 99, CRT: 2 },
          deterioration: { HR: 1 },
          interventions: { 'Apply Splint': { key: 'Apply Splint', effect: { HR: -5 }, stopsDeterioration: true, feedback: 'Wrist splinted, pain reduced.' } }
        },
        'Elderly Fall + Head Laceration': {
          name: 'Elderly Fall + Head Laceration', type: 'minor', canSelfExtricate: true, bodyPart: 'head', marker: 'L',
          moulage: 'Small scalp wound, oozing blood.',
          briefing: '80-year-old with AF on anticoagulants.',
          vitals: { GCS: 14, HR: 80, RR: 18, SBP: 140, SpO2: 97, CRT: 2 },
          deterioration: { GCS: -1 },
          interventions: { 'Immobilise & Dress Wound': { key: 'Immobilise & Dress Wound', effect: {}, stopsDeterioration: true, feedback: 'Patient immobilised and wound dressed.' } }
        },
        'Chemical Burn (Arm)': {
          name: 'Chemical Burn (Arm)', type: 'moderate', canSelfExtricate: false, bodyPart: 'arm_right', marker: 'B',
          moulage: 'Skin blistering and redness, chemical odour.',
          briefing: 'Severe stinging pain after exposure.',
          vitals: { GCS: 15, HR: 105, RR: 20, SBP: 125, SpO2: 98, CRT: 2 },
          deterioration: { HR: 3 },
          interventions: { 'Irrigate & Dress Burn': { key: 'Irrigate & Dress Burn', effect: { HR: -5 }, stopsDeterioration: true, feedback: 'Burn irrigated and dressed.' } }
        }
      },
      ampleHistory: {
        allergies: ['NKDA', 'Penicillin', 'Latex', 'Nuts'],
        medications: ['None', 'Warfarin', 'DOAC', 'Insulin', 'Salbutamol inhaler', 'Aspirin'],
        pastHistory: ['Asthma', 'Diabetes', 'Hypertension', 'IHD', 'COPD', 'Epilepsy'],
        lastMeal: ['Breakfast', 'Sandwich at lunch', 'Tea', 'Snack', 'Skipped meal'],
        events: [
          { text: 'Driving home from work', context: ['rtc'] },
          { text: 'Passenger in a vehicle', context: ['rtc'] },
          { text: 'Cycling when hit by a car', context: ['rtc'] },
          { text: 'Fell from a ladder', context: ['trauma'] },
          { text: 'Caught in machinery', context: ['trauma'] },
          { text: 'Using power tools at home', context: ['trauma'] }
        ]
      },
      vehicles: {
        'Saloon Car': { type: 'Saloon Car', capacity: 5, hasUHSS: false, isEV: false, length_m: 4.6 },
        'Tesla Model 3': { type: 'Tesla Model 3', capacity: 5, hasUHSS: true, isEV: true, length_m: 4.7 }
      },
      vehiclePositions: [
        { name: 'Upright on all fours', rotation: 0 }, { name: 'On roof', rotation: 180 },
        { name: 'Driverâ€™s side', rotation: 90 }, { name: 'Passengerâ€™s side', rotation: -90 }
      ],
      hazardTemplates: [
        { type: 'Fuel Spill', minR: 35, maxR: 70 }, { type: 'Fire', minR: 15, maxR: 28 },
        { type: 'Wall', width_m: 4, height_m: 0.5 }, { type: 'Lamppost' },
        { type: 'Battery Fire', minR: 18, maxR: 28 }
      ],
      casualtyPositions: {
        'Driver': { x: 25, y: -40 }, 'Front Passenger': { x: -25, y: -40 },
        'Rear Offside': { x: 25, y: 40 }, 'Rear Nearside': { x: -25, y: 40 }
      }
    };


    // js/log.js
    let incidentLog = [];

    function addLog(message, type = 'info', timeText = null) {
      const entry = {
        time: timeText ?? new Date().toLocaleTimeString('en-GB'),
        message,
        type
      };
      incidentLog.push(entry);
      const logEl = document.getElementById('scenario-log');
      if (logEl) {
        const cls = type === 'good' ? 'border-green-500' :
                    type === 'bad' ? 'border-red-500' :
                    type === 'command' ? 'border-amber-500' : 'border-gray-500';
        logEl.innerHTML += `<div class="border-l-4 ${cls} pl-2 text-sm"><span class="text-gray-400">[${entry.time}]</span> ${entry.message}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
      }
    }
    function clearLog() { incidentLog = []; }

    // js/scenario.js
    const rand = (min, max) => Math.random() * (max - min) + min;
    const randInt = (min, max) => Math.floor(rand(min, max + 1));
    const choice = arr => arr[Math.floor(Math.random() * arr.length)];
    const pickKeys = obj => Object.keys(obj);
    function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }
    function near(anchorX, anchorY, radius = 80) {
      const x = clamp(anchorX + rand(-radius, radius), 40, CANVAS_W - 40);
      const y = clamp(anchorY + rand(-radius, radius), 40, CANVAS_H - 40);
      return { x, y };
    }
    function randomLayoutType() {
      return Math.random() < 0.6 ? 't-junction' : 'offset-headon';
    }

    function makeCasualty(id, context, injuryKeyOverride = null) {
      const injuryKey = injuryKeyOverride || choice(pickKeys(frameworkData.injuries));
      const injury = frameworkData.injuries[injuryKey];
      const ageBuckets = [
        () => randInt(6, 12), () => randInt(16, 30),
        () => randInt(31, 55), () => randInt(65, 88)
      ];
      const age = Math.random() < 0.12 ? ageBuckets[0]() :
                  Math.random() < 0.55 ? ageBuckets[1]() :
                  Math.random() < 0.85 ? ageBuckets[2]() : ageBuckets[3]();
      const vitals = { ...injury.vitals };
      const relevantEvents = frameworkData.ampleHistory.events.filter(e => e.context.includes(context));
      const event = choice(relevantEvents).text;

      return {
        id, age,
        injuries: [{ ...injury, key: injuryKey }],
        vitals: { ...vitals },
        prevVitals: { ...vitals },
        treatedInjuries: new Set(),
        entrapment: injury.canSelfExtricate ? 'No physical entrapment.' : 'Physical entrapment by intrusion.',
        ample: {
          A: choice(frameworkData.ampleHistory.allergies), M: choice(frameworkData.ampleHistory.medications),
          P: choice(frameworkData.ampleHistory.pastHistory), L: choice(frameworkData.ampleHistory.lastMeal),
          E: event
        },
        initialVitals: { ...vitals },
        overrideState: 'normal', // 'normal', 'arrest', 'stabilised'
        vitalsHistory: []
      };
    }

    function instantiateHazard(t, anchor) {
      const pos = near(anchor.x, anchor.y, 140);
      if (t.type === 'Fuel Spill') return { type: t.type, x: pos.x, y: pos.y, rx: rand(t.minR, t.maxR), ry: rand(t.minR * 0.4, t.maxR * 0.7), rotation: rand(0, Math.PI) };
      if (t.type === 'Fire' || t.type === 'Battery Fire') return { type: t.type, x: pos.x, y: pos.y, r: rand(t.minR, t.maxR) };
      if (t.type === 'Wall') return { type: t.type, x: rand(80, CANVAS_W - 80 - 16), y: rand(60, 120), w: t.width_m * 16, h: t.height_m * 16 };
      if (t.type === 'Lamppost') return { type: t.type, x: rand(70, CANVAS_W - 70), y: rand(140, CANVAS_H - 140) };
      return null;
    }

    function spawnHazards(vehicles, probability, forced = [], includeBatteryFire = false) {
      const anchor = vehicles[0] ? { x: vehicles[0].x, y: vehicles[0].y } : { x: CANVAS_W * 0.5, y: CANVAS_H * 0.5 };
      const isEVPresent = vehicles.some(v => v.isEV);
      const pool = frameworkData.hazardTemplates.filter(t => !(t.type === 'Battery Fire' && !(isEVPresent && includeBatteryFire)));
      const chosen = pool.map(t => (forced.includes(t.type) || (t.type !== 'Battery Fire' && Math.random() < probability)) ? instantiateHazard(t, anchor) : null).filter(Boolean);
      return [...new Map(chosen.map(item => [item.type, item])).values()];
    }

    function spawnVehicles(numVehicles, layout) {
      const vehicleKeys = pickKeys(frameworkData.vehicles);
      const colors = ['#60a5fa', '#facc15', '#4ade80', '#fb7185'];
      return Array.from({ length: numVehicles }, (_, i) => {
        const proto = frameworkData.vehicles[choice(vehicleKeys)];
        const isTJunction = layout === 't-junction';
        const rotation = isTJunction ? (i === 0 ? rand(-12, 12) : rand(78, 100)) : rand(-15, 15);
        const x = isTJunction ? (i === 0 ? CANVAS_W * 0.42 : CANVAS_W * 0.53) + rand(-20, 20) : CANVAS_W * (0.35 + i * 0.18) + rand(-10, 10);
        const y = isTJunction ? (i === 0 ? CANVAS_H * 0.40 : CANVAS_H * 0.56) + rand(-15, 15) : CANVAS_H * (0.44 + i * 0.1) + rand(-12, 12);
        return {
          ...proto, id: i, color: colors[i % colors.length],
          position: { name: 'Upright on all fours', rotation }, x, y,
          impactType: isTJunction ? (i === 0 ? 'frontal' : 'side') : 'frontal',
          impactSide: isTJunction && i > 0 ? (Math.random() < 0.5 ? 'nearside' : 'offside') : null,
          damage: isTJunction ? (i === 0 ? 'Frontal intrusion' : 'Side intrusion') : 'Frontal intrusion',
          casualties: []
        };
      });
    }

    function generateRtcScenario(numVehicles = 2, numPatients = 2, options = {}) {
      const { hazardProbability = 0.55, forceHazards = [], includeEVBatteryHazard = false, presetInjuries = [] } = options;
      const layout = randomLayoutType();
      const vehicles = spawnVehicles(numVehicles, layout);
      numPatients = Math.min(numPatients, vehicles.reduce((a, v) => a + v.capacity, 0));
      const casualties = Array.from({ length: numPatients }, (_, i) => makeCasualty(i, 'rtc', presetInjuries[i] || null));
      casualties.forEach((cas, idx) => vehicles[idx % vehicles.length].casualties.push(cas));
      const hazards = spawnHazards(vehicles, hazardProbability, forceHazards, includeEVBatteryHazard);
      return {
        type: 'RTC', title: 'RTC Challenge', timeLimit: 20,
        location: layout === 't-junction' ? 'Urban T-Junction' : 'Urban A-Road',
        hazards: hazards.map(h => h.type).join(', ') || 'None obvious',
        vehicles, casualties, environmentalObjects: hazards, layoutType: layout,
        canvas: { width: CANVAS_W, height: CANVAS_H },
        scoresheet: {}
      };
    }

    function generateTraumaScenario(numPatients = 2, options = {}) {
      const { hazardProbability = 0.42, forceHazards = [], presetInjuries = [] } = options;
      const casualties = Array.from({ length: numPatients }, (_, i) => makeCasualty(i, 'trauma', presetInjuries[i] || null));
      const hazards = spawnHazards([], hazardProbability, forceHazards, false);
      return {
        type: 'Trauma', title: 'Trauma Challenge', timeLimit: 12,
        location: 'Industrial unit',
        hazards: hazards.map(h => h.type).join(', ') || 'None obvious',
        vehicles: [], casualties, environmentalObjects: hazards, layoutType: 't-junction',
        canvas: { width: CANVAS_W, height: CANVAS_H },
        scoresheet: {}
      };
    }

    // js/drawing.js
    function drawSetupScene(canvas, scenario) {
      if (!canvas || !scenario) return;
      const ctx = canvas.getContext('2d');
      const W = canvas.width;
      const H = canvas.height;
      ctx.clearRect(0, 0, W, H);
      drawRoadLayout(ctx, W, H, scenario.layoutType);
      (scenario.environmentalObjects || []).forEach(h => drawHazard(ctx, h));
      (scenario.vehicles || []).forEach((v, idx) => {
        drawVehicle(ctx, v.x, v.y, v.position.rotation, v.color, String.fromCharCode(65 + idx), v.type, v.isEV, v.hasUHSS);
        if (v.impactType === 'frontal') drawImpact(ctx, v.x, v.y, v.position.rotation, 60);
        else if (v.impactType === 'side') drawSideImpact(ctx, v.x, v.y, v.position.rotation, v.impactSide);
        (v.casualties || []).forEach((cas, ci) => {
          const ox = (ci % 2 === 0 ? -20 : 20) + rand(-8, 8);
          const oy = (ci < 2 ? -26 : 18) + rand(-6, 6);
          drawCasualty(ctx, v.x + rotateX(ox, oy, v.position.rotation), v.y + rotateY(ox, oy, v.position.rotation), `C${cas.id + 1}`);
        });
      });
    }

    function drawRoadLayout(ctx, W, H, type) {
      ctx.fillStyle = '#c8e6c9';
      ctx.fillRect(0, 0, W, H);
      ctx.fillStyle = '#bdbdbd';
      if (type === 't-junction') {
        ctx.fillRect(0, H * 0.32, W, H * 0.36);
        ctx.fillRect(W * 0.35, 0, W * 0.3, H);
        ctx.strokeStyle = 'white';
        ctx.setLineDash([14, 22]);
        line(ctx, 0, H * 0.5, W, H * 0.5);
        line(ctx, W * 0.5, 0, W * 0.5, H);
        ctx.setLineDash([]);
      } else {
        ctx.fillRect(0, H * 0.36, W, H * 0.28);
        ctx.fillStyle = '#9e9e9e';
        ctx.fillRect(W * 0.72, H * 0.2, W * 0.18, H * 0.2);
        ctx.strokeStyle = 'white';
        ctx.setLineDash([14, 22]);
        line(ctx, 0, H * 0.5, W, H * 0.5);
        ctx.setLineDash([]);
      }
    }

    function drawVehicle(ctx, x, y, rotationDeg, color, label, type, isEV, hasUHSS) {
      ctx.save();
      ctx.translate(x, y);
      ctx.rotate((rotationDeg * Math.PI) / 180);
      ctx.fillStyle = color || '#90caf9';
      ctx.strokeStyle = '#424242';
      ctx.lineWidth = 1;
      roundRect(ctx, -52, -24, 104, 48, 6, true, true);
      ctx.fillStyle = '#e3f2fd';
      roundRect(ctx, -36, -18, 72, 16, 4, true, false);
      ctx.restore();
      ctx.save();
      ctx.translate(x,y);
      ctx.fillStyle = '#212121';
      ctx.font = 'bold 16px Inter';
      ctx.textAlign = 'center';
      ctx.fillText(label, 0, 5);
      if (isEV) {
        ctx.fillStyle = '#d1e7dd'; roundRect(ctx, -50, -46, 36, 14, 7, true, false);
        ctx.fillStyle = '#0f5132'; ctx.font = '10px Inter'; ctx.fillText('EV', -32, -36);
      }
      if (hasUHSS) {
        ctx.fillStyle = '#e2e3e5'; roundRect(ctx, 14, -46, 40, 14, 7, true, false);
        ctx.fillStyle = '#41464b'; ctx.font = '10px Inter'; ctx.fillText('UHSS', 34, -36);
      }
      ctx.restore();
    }

    function drawCasualty(ctx, x, y, label) {
      ctx.save();
      ctx.fillStyle = '#d32f2f'; ctx.beginPath(); ctx.arc(x, y, 8, 0, Math.PI * 2); ctx.fill();
      ctx.fillStyle = 'white'; ctx.font = 'bold 10px Inter'; ctx.textAlign = 'center'; ctx.fillText(label, x, y + 4);
      ctx.restore();
    }

    function drawImpact(ctx, x, y, rotationDeg, offset) {
      const ox = rotateX(0, -offset, rotationDeg); const oy = rotateY(0, -offset, rotationDeg);
      ctx.save(); ctx.fillStyle = '#f97316'; ctx.font = '20px Inter'; ctx.fillText('ðŸ’¥', x + ox, y + oy); ctx.restore();
    }

    function drawSideImpact(ctx, x, y, rotationDeg, side) {
      const s = side === 'nearside' ? -1 : 1;
      const ox = rotateX(48 * s, 0, rotationDeg); const oy = rotateY(48 * s, 0, rotationDeg);
      ctx.save(); ctx.fillStyle = '#f97316'; ctx.font = '20px Inter'; ctx.fillText('ðŸ’¥', x + ox, y + oy); ctx.restore();
    }

    function drawHazard(ctx, h) {
      ctx.save();
      if (h.type === 'Fuel Spill') {
        ctx.translate(h.x, h.y); ctx.rotate(h.rotation || 0);
        ctx.fillStyle = 'rgba(59,130,246,0.35)'; ellipse(ctx, 0, 0, h.rx || 50, h.ry || 25, true, false);
        ctx.fillStyle = '#212121'; ctx.font = '11px Inter'; ctx.textAlign = 'center'; ctx.fillText('Fuel Spill', 0, 4);
      } else if (h.type === 'Fire') {
        ctx.fillStyle = '#fb923c'; ctx.beginPath(); ctx.arc(h.x, h.y, h.r || 20, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = '#d32f2f'; ctx.font = '14px Inter'; ctx.textAlign = 'center'; ctx.fillText('ðŸ”¥ Fire', h.x, h.y + 4);
      } else if (h.type === 'Battery Fire') {
        ctx.fillStyle = '#fb923c'; ctx.beginPath(); ctx.arc(h.x, h.y, h.r || 20, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = '#d32f2f'; ctx.font = '14px Inter'; ctx.textAlign = 'center'; ctx.fillText('âš¡ï¸ðŸ”¥', h.x, h.y + 4);
      } else if (h.type === 'Wall') {
        ctx.fillStyle = '#7e57c2'; roundRect(ctx, h.x, h.y, h.w || 80, h.h || 12, 4, true, false);
      } else if (h.type === 'Lamppost') {
        ctx.fillStyle = '#9e9e9e'; ctx.fillRect(h.x - 5, h.y - 40, 10, 60);
        ctx.fillStyle = '#ffeb3b'; ctx.beginPath(); ctx.arc(h.x, h.y - 44, 12, 0, Math.PI * 2); ctx.fill();
      }
      ctx.restore();
    }
    function line(ctx, x1, y1, x2, y2) { ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke(); }
    function roundRect(ctx, x, y, w, h, r, fill, stroke) {
      if (typeof r === 'number') r = { tl: r, tr: r, br: r, bl: r };
      ctx.beginPath(); ctx.moveTo(x + r.tl, y); ctx.lineTo(x + w - r.tr, y); ctx.quadraticCurveTo(x + w, y, x + w, y + r.tr);
      ctx.lineTo(x + w, y + h - r.br); ctx.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h); ctx.lineTo(x + r.bl, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r.bl); ctx.lineTo(x, y + r.tl); ctx.quadraticCurveTo(x, y, x + r.tl, y); ctx.closePath();
      if (fill) ctx.fill(); if (stroke) ctx.stroke();
    }
    function ellipse(ctx, x, y, rx, ry, fill, stroke) { ctx.beginPath(); ctx.ellipse(x, y, rx, ry, 0, 0, Math.PI * 2); if (fill) ctx.fill(); if (stroke) ctx.stroke(); }
    function rotateX(x, y, deg) { const r = (deg * Math.PI) / 180; return x * Math.cos(r) - y * Math.sin(r); }
    function rotateY(x, y, deg) { const r = (deg * Math.PI) / 180; return x * Math.sin(r) + y * Math.cos(r); }

    // sim.js
    function vitalTrendLine(cas) {
      if (cas.overrideState === 'arrest') return 'CARDIAC ARREST';
      const v = cas.vitals; const p = cas.prevVitals || v;
      const arrow = (curr, prev) => curr > prev ? 'â–²' : curr < prev ? 'â–¼' : 'â–¬';
      const bp = `${v.SBP}/${Math.round(v.SBP * 0.6)}`;
      return `GCS:${v.GCS} ${arrow(v.GCS, p.GCS)} | HR:${v.HR} ${arrow(v.HR, p.HR)} | RR:${v.RR} ${arrow(v.RR, p.RR)} | BP:${bp} | SpO2:${v.SpO2}% ${arrow(v.SpO2, p.SpO2)} | CRT:${v.CRT}s ${arrow(v.CRT, p.CRT)}`;
    }
    
    function checkPhysiologicalPlausibilityAndArrest(cas) {
        if (cas.overrideState !== 'normal') return;
        let changed = false;
        // GCS drops with poor perfusion
        if (cas.vitals.SBP < 60 && cas.vitals.GCS > 10) { cas.vitals.GCS = 10; changed = true; }
        if (cas.vitals.SBP < 50 && cas.vitals.GCS > 8) { cas.vitals.GCS = 8; changed = true; }
        
        // Arrest conditions
        if (cas.vitals.SBP < 40) {
            cas.overrideState = 'arrest';
            addLog(`Casualty ${cas.id + 1} has gone into CARDIAC ARREST (Hypovolaemia).`, 'bad');
            return; // Stop further checks
        }
        if (changed) { addLog(`Casualty ${cas.id + 1} GCS deteriorating due to poor perfusion.`, 'bad');}
    }

    function simulationTick(allCasualties) {
      (allCasualties || []).forEach(cas => {
        const time = state.seconds;
        cas.vitalsHistory.push({ time, ...cas.vitals });

        if (cas.overrideState !== 'normal') {
            if(cas.overrideState === 'arrest') {
                cas.vitals = { GCS: 3, HR: 0, RR: 0, SBP: 0, SpO2: 0, CRT: 0 };
            }
            return;
        };
        cas.prevVitals = { ...cas.vitals };
        let changed = false;
        (cas.injuries || []).forEach(inj => {
          if (cas.treatedInjuries?.has?.(inj.key)) return;
          if (inj.deterioration) {
            Object.entries(inj.deterioration).forEach(([k, delta]) => {
              const before = cas.vitals[k];
              if (k === 'GCS') cas.vitals[k] = Math.max(3, Math.round(before + delta));
              else cas.vitals[k] = Math.max(0, Math.round(before + delta));
              changed = true;
            });
          }
        });
        cas.vitals.HR += Math.random() < 0.25 ? (Math.random() < 0.5 ? 1 : -1) : 0;
        cas.vitals.RR += Math.random() < 0.2 ? (Math.random() < 0.5 ? 1 : -1) : 0;

        if (changed) {
          addLog(`Casualty ${cas.id + 1} showing deterioration.`, 'bad');
          const card = document.getElementById(`casualty-card-${cas.id}`);
          if (card) {
            card.classList.add('flash-red');
            setTimeout(() => card.classList.remove('flash-red'), 1500);
          }
        }
        checkPhysiologicalPlausibilityAndArrest(cas);
      });
    }

    function applyIntervention(cas, injuryKey, interventionKey, btnEl) {
      const inj = cas?.injuries?.find(i => i.key === injuryKey);
      const intervention = inj?.interventions?.[interventionKey];
      if (!inj || !intervention) return;
      cas.prevVitals = { ...cas.vitals };
      Object.entries(intervention.effect || {}).forEach(([k, v]) => {
        cas.vitals[k] = Math.max(0, Math.round(cas.vitals[k] + v));
      });
      if (intervention.stopsDeterioration) {
        cas.treatedInjuries.add(injuryKey);
        if (btnEl) btnEl.disabled = true;
      }
      addLog(`Intervention on Casualty ${cas.id + 1}: ${intervention.feedback}`, 'good');
       cas.vitalsHistory.push({ time: state.seconds, ...cas.vitals, intervention: intervention.key });
    }

    // ui.js
    let state = {
      scenario: null, timer: null, simTicker: null,
      seconds: 0, paused: true, deteriorationPaused: false
    };

    function showFeedback(element, text) {
      const feedback = document.createElement('div');
      feedback.textContent = text;
      Object.assign(feedback.style, {
        position: 'absolute', background: '#28a745', color: 'white',
        padding: '2px 8px', borderRadius: '4px', fontSize: '12px',
        top: `${element.offsetTop - 25}px`, left: `${element.offsetLeft}px`,
        transition: 'opacity 0.5s, transform 0.5s', transform: 'translateY(10px)',
        pointerEvents: 'none', zIndex: '1000'
      });
      document.body.appendChild(feedback);
      setTimeout(() => { feedback.style.opacity = '1'; feedback.style.transform = 'translateY(0)'; }, 10);
      setTimeout(() => { feedback.style.opacity = '0'; setTimeout(() => feedback.remove(), 500); }, 1500);
    }

    function handleActionClick(target) {
        const { casualtyId, action, injuryKey, interventionKey, override, event, scoresheetItem } = target.dataset;
        const cas = casualtyId ? state.scenario.casualties.find(c => c.id == casualtyId) : null;
        
        if (action) {
            const msg = casualtyId ? `C${parseInt(casualtyId,10)+1}: ${action}` : action;
            addLog(msg, 'command');
            showFeedback(target, 'Logged!');
            if (action !== 'Reassess') { // Allow Reassess to be clicked multiple times
                target.disabled = true;
                target.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
        if (interventionKey) {
            applyIntervention(cas, injuryKey, interventionKey, target);
            showFeedback(target, 'Applied!');
            target.disabled = true;
            target.classList.add('opacity-50', 'cursor-not-allowed');
        }
        if (override && cas) {
            const current = cas.overrideState;
            const otherBtnId = override === 'arrest' ? `stabilise-btn-${cas.id}` : `arrest-btn-${cas.id}`;
            document.getElementById(otherBtnId)?.classList.remove('active');

            if (current === override) { // Toggle off
                cas.overrideState = 'normal';
                target.classList.remove('active');
                addLog(`C${cas.id+1} override '${override}' CANCELLED.`, 'command');
            } else { // Toggle on
                cas.overrideState = override;
                target.classList.add('active');
                addLog(`C${cas.id+1} override set to '${override}'.`, 'command');
                 if(override === 'arrest') { cas.vitalsHistory.push({ time: state.seconds, ...cas.vitals, event: 'Arrest' }); }
            }
        }
        if (event) {
            const msg = `Dynamic Event: ${event} introduced for Casualty ${parseInt(casualtyId, 10) + 1}`;
            addLog(msg, 'bad');
            if (event === 'Agitated') {
                cas.vitals.GCS = Math.max(3, cas.vitals.GCS - 2);
                setTimeout(() => { cas.vitals.GCS = Math.min(15, cas.vitals.GCS + 2); }, 60000);
            } else if (event === 'Fitting') {
                const oldVitals = { ...cas.vitals };
                cas.vitals.HR = 150; cas.vitals.RR = 40; cas.vitals.SpO2 = 85;
                setTimeout(() => { cas.vitals = oldVitals; }, 30000);
            }
        }
        if (scoresheetItem) {
            const [category, item] = scoresheetItem.split(':');
            if (!state.scenario.scoresheet[category]) state.scenario.scoresheet[category] = {};
            state.scenario.scoresheet[category][item] = true;
            addLog(`Scoresheet: [${category}] ${item} - CHECKED`, 'good');
            target.disabled = true;
        }
    }

    function injuryOptionsHTML() {
      const injuries = Object.keys(frameworkData.injuries);
      return `<option value="">Random</option>` + injuries.map(k => `<option value="${k}">${k}</option>`).join('');
    }

    function renderPatientInjurySelectors(count) {
        const container = document.getElementById('patient-injury-selectors');
        if (!container) return;
        let html = '';
        for (let i = 0; i < count; i++) {
            html += `<div class="flex items-center gap-2 mb-2">
                <label class="w-28 text-sm text-gray-700">Patient ${i+1}:</label>
                <select class="patient-injury-select flex-grow bg-white border border-gray-300 rounded-lg p-2" data-patient-index="${i}">
                    ${injuryOptionsHTML()}
                </select>
            </div>`;
        }
        container.innerHTML = html;
    }

    function showMenu() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div id="main-menu" class="bg-white p-6 rounded-lg shadow-lg border">
          <h2 class="text-2xl font-bold mb-4">Generate Scenario</h2>
          <div class="bg-gray-50 p-4 rounded-lg mb-4 border">
            <h3 class="text-lg font-bold mb-2">Preset Injuries (optional)</h3>
            <p class="text-sm text-gray-700 mb-2">Select injuries for each patient. Leave as 'Random' for a surprise.</p>
            <div id="patient-injury-selectors"></div>
          </div>
          <div id="controls" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-gray-50 p-4 rounded-lg border">
              <h3 class="text-lg font-bold mb-2">RTC Scenario</h3>
              <label class="block text-sm text-gray-700 mb-1">Vehicles</label>
              <select id="rtc-vehicles" class="bg-white border border-gray-300 rounded-lg w-full p-2 mb-2"><option>1</option><option selected>2</option><option>3</option></select>
              <label class="block text-sm text-gray-700 mb-1">Patients</label>
              <select id="rtc-patients" class="bg-white border border-gray-300 rounded-lg w-full p-2 mb-2"><option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option></select>
              <div class="mt-3 space-y-2">
                <label class="flex items-center gap-2"><input id="opt-evhaz" type="checkbox" class="h-4 w-4"><span class="text-sm">Include EV battery hazard if EV present</span></label>
                <label class="block text-sm text-gray-700">Force hazards:</label>
                <div class="grid grid-cols-2 gap-1 text-sm">${['Fuel Spill','Fire','Battery Fire','Wall','Lamppost'].map(h => `<label class="flex items-center gap-2"><input type="checkbox" class="force-hazard" value="${h}"/><span>${h}</span></label>`).join('')}</div>
                <label class="block text-sm text-gray-700 mt-2">Hazard probability (<span id="hpLabel">55</span>%):</label>
                <input id="opt-hp" type="range" min="0" max="100" value="55" class="w-full" oninput="document.getElementById('hpLabel').textContent = this.value">
              </div>
              <button id="genRtc" class="btn btn-primary w-full mt-3">Generate RTC</button>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg border">
              <h3 class="text-lg font-bold mb-2">Trauma Scenario</h3>
              <label class="block text-sm text-gray-700 mb-1">Patients</label>
              <select id="trauma-patients" class="bg-white border border-gray-300 rounded-lg w-full p-2 mb-2"><option>1</option><option selected>2</option><option>3</option><option>4</option></select>
              <div class="mt-3 space-y-2">
                <label class="block text-sm text-gray-700">Force hazards:</label>
                <div class="grid grid-cols-2 gap-1 text-sm">${['Fuel Spill','Fire','Battery Fire','Wall','Lamppost'].map(h => `<label class="flex items-center gap-2"><input type="checkbox" class="force-hazard-trauma" value="${h}"/><span>${h}</span></label>`).join('')}</div>
                <label class="block text-sm text-gray-700 mt-2">Hazard probability (<span id="hpLabelT">42</span>%):</label>
                <input id="opt-hp-trauma" type="range" min="0" max="100" value="42" class="w-full" oninput="document.getElementById('hpLabelT').textContent = this.value">
              </div>
              <button id="genTrauma" class="btn btn-secondary w-full mt-3">Generate Trauma</button>
            </div>
          </div>
        </div>`;
        const rtcPatientCount = document.getElementById('rtc-patients');
        const traumaPatientCount = document.getElementById('trauma-patients');
        const updateSelectors = () => renderPatientInjurySelectors(parseInt(document.getElementById('rtc-patients').value, 10)); // Always base on RTC for now
        rtcPatientCount.addEventListener('change', updateSelectors);
        traumaPatientCount.addEventListener('change', () => renderPatientInjurySelectors(parseInt(traumaPatientCount.value, 10)));
        renderPatientInjurySelectors(parseInt(rtcPatientCount.value, 10)); // Initial render
    }

    function renderSetupScreen(scenario) {
      state = { ...state, scenario }; clearLog();
      const app = document.getElementById('app');
      app.innerHTML = `
        <div id="setup-screen" class="bg-white p-6 rounded-lg shadow-lg space-y-6 border">
          <div class="flex justify-between items-center"><h2 class="text-2xl font-bold">Instructor Briefing</h2><div class="flex gap-2"><button id="backBtn" class="btn btn-secondary">Back to Menu</button><button id="printBtn" class="btn btn-tertiary">Print Briefing</button></div></div>
          <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <div class="lg:col-span-3 bg-gray-50 p-4 rounded-lg border"><h3 class="text-xl font-bold mb-2">Top-Down View</h3><canvas id="setupCanvas" width="${scenario.canvas.width}" height="${scenario.canvas.height}" class="w-full h-auto bg-gray-200 rounded"></canvas></div>
            <div class="lg:col-span-2 bg-gray-50 p-4 rounded-lg border"><h3 class="text-xl font-bold mb-2">Incident Details</h3><div class="text-sm space-y-2"><p><strong>Location:</strong> ${scenario.location}</p><p><strong>Time Limit:</strong> <span class="font-bold text-red-600">${scenario.timeLimit} mins</span></p><p><strong>Hazards:</strong> <span class="text-yellow-600">${scenario.hazards}</span></p>${(scenario.vehicles||[]).map((v,i)=>`<div class="bg-white p-2 rounded border mt-2"><h4 class="font-bold">Vehicle ${String.fromCharCode(65+i)} â€” ${v.type}</h4><p class="text-xs">Pos: ${v.position.name} | Dmg: ${v.damage}</p><p class="text-xs">UHSS: ${v.hasUHSS?'Yes':'No'} | EV: ${v.isEV?'Yes':'No'}</p></div>`).join('')}</div></div>
          </div>
          <div><h3 class="text-xl font-bold mb-2">Casualty Briefing Sheets</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${(scenario.casualties||[]).map(c=>`<div class="bg-gray-50 p-3 rounded border"><div class="flex items-center justify-between flex-wrap"><h4 class="font-bold">Casualty ${c.id+1} â€” Age ${c.age}</h4><span class="font-mono text-xs bg-gray-200 px-2 py-1 rounded">GCS:${c.vitals.GCS}|HR:${c.vitals.HR}|RR:${c.vitals.RR}|SBP:${c.vitals.SBP}|SpO2:${c.vitals.SpO2}%|CRT:${c.vitals.CRT}s</span></div><p class="text-amber-600 text-sm mt-1"><strong>Suspected:</strong> ${(c.injuries||[]).map(i=>i.name).join(', ')}</p><p class="text-gray-600 text-sm mt-1"><strong>AMPLE:</strong> A:${c.ample.A}|M:${c.ample.M}|P:${c.ample.P}|L:${c.ample.L}|E:${c.ample.E}</p></div>`).join('')}</div></div>
          <div class="text-center"><button id="startSimBtn" class="btn btn-primary w-full md:w-1/2 mt-2">Proceed to Live Simulation</button></div>
        </div>`;
      drawSetupScene(document.getElementById('setupCanvas'), scenario);
    }

    function renderLiveSim(scenario) {
        const actionButton = (label, color, type, dataAttrs = '') => `<button class="${type}-btn bg-${color}-600 hover:bg-${color}-700 text-white text-xs font-bold py-1 px-2 rounded" ${dataAttrs}>${label}</button>`;
        const actionGroup = (title, actions, color, type, casId = null) => `<div class="mb-1"><p class="text-xs font-semibold text-gray-600">${title}:</p><div class="flex flex-wrap gap-1 mt-1">${actions.map(act => actionButton(act, color, type, `data-action="${act}"` + (casId !== null ? ` data-casualty-id="${casId}"` : ''))).join('')}</div></div>`;
        const vehicleActions = (scenario.vehicles || []).map((v, i) => `<div class="p-2 border rounded bg-white mt-1">${actionGroup(`Vehicle ${String.fromCharCode(65+i)}`, ['Stabilisation', 'Glass Management', 'Power Down'], 'cyan', 'vehicle-action')}</div>`).join('');
        const scoresheetHTML = (category) => frameworkData.scoresheets[category].map(item => `<label class="flex items-center gap-2 p-1"><input type="checkbox" data-scoresheet-item="${category}:${item}"><span>${item}</span></label>`).join('');

        const casCards = (scenario.casualties||[]).map(c => `
            <div id="casualty-card-${c.id}" class="bg-gray-50 p-3 rounded border transition-all duration-300">
                <div class="flex justify-between items-start">
                    <h4 class="font-bold">Casualty ${c.id+1}</h4>
                    <div class="flex gap-1">
                        <button id="arrest-btn-${c.id}" class="override-btn btn-secondary text-xs py-1 px-2 rounded" style="--color: var(--ukro-red);" data-casualty-id="${c.id}" data-override="arrest">Arrest</button>
                        <button id="stabilise-btn-${c.id}" class="override-btn btn-primary text-xs py-1 px-2 rounded" style="--color: var(--ukro-blue);" data-casualty-id="${c.id}" data-override="stabilised">Stabilise</button>
                    </div>
                </div>
                <div id="vitals-${c.id}" class="font-mono text-center my-2 p-2 bg-gray-200 rounded text-sm">${vitalTrendLine(c)}</div>
                <div class="space-y-2">
                    ${actionGroup('Assessment', ['Hands on', 'Reassess', 'Primary Survey Complete'], 'emerald', 'casualty-action', c.id)}
                    ${actionGroup('Primary Survey Steps', ['Airway', 'Breathing', 'Circulation', 'Disability', 'Expose'], 'sky', 'casualty-action', c.id)}
                    <div>
                        <p class="text-xs font-semibold text-gray-600 mb-1">Interventions:</p>
                        <div class="flex flex-wrap gap-2 justify-center">${(c.injuries||[]).flatMap(inj => Object.values(inj.interventions||{}).map(iv=>actionButton(iv.key,'indigo','intervention',`data-casualty-id="${c.id}" data-injury-key="${inj.key}" data-intervention-key="${iv.key}"`))).join('')||'<span class="text-gray-500 text-sm">None available</span>'}</div>
                    </div>
                </div>
            </div>`).join('');

        const liveSimContainer = document.createElement('div');
        liveSimContainer.id = 'live-sim';
        liveSimContainer.className = 'bg-white p-6 rounded-lg shadow-lg space-y-6 border mt-6';
        liveSimContainer.innerHTML = `
            <div class="flex justify-between items-center flex-wrap"><h2 class="text-2xl font-bold">Live Simulation</h2><div class="flex items-center gap-2"><div id="timer" class="text-2xl font-mono font-bold text-red-600 bg-gray-200 px-3 py-1 rounded-md">00:00</div><button id="timerControlBtn" class="btn btn-tertiary w-28">Start Sim</button></div></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                     <div class="bg-gray-50 p-4 rounded-lg border">
                        <h3 class="text-lg font-bold mb-2 text-amber-600">Command & Technical Actions</h3>
                        ${actionGroup('Scene', ['Size-Up','360 Survey','Hazards ID'], 'amber', 'scenario-action')}
                        ${actionGroup('Plan', ['Rapid Plan','Tactical Plan','EV/UHSS OK'], 'amber', 'scenario-action')}
                        ${vehicleActions ? `<div class="mt-2"><h4 class="text-md font-bold mb-1">Vehicle Actions</h4>${vehicleActions}</div>` : ''}
                    </div>
                     <div class="bg-gray-50 p-4 rounded-lg border mt-4">
                        <h3 class="text-lg font-bold mb-2 text-red-700">Dynamic Events</h3>
                        <div class="grid grid-cols-2 gap-2">
                            ${scenario.casualties.map(c => `
                                <div class="border p-2 rounded bg-white">
                                    <p class="font-bold text-sm mb-1">Casualty ${c.id+1}</p>
                                    ${actionButton('Agitated', 'orange', 'event-btn', `data-casualty-id="${c.id}" data-event="Agitated"`)}
                                    ${actionButton('Fitting', 'red', 'event-btn', `data-casualty-id="${c.id}" data-event="Fitting"`)}
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-2"> ${actionButton('Introduce New Fire', 'red', 'event-btn', `data-event="New Fire"`)} ${actionButton('Introduce Fuel Spill', 'blue', 'event-btn', `data-event="New Fuel Spill"`)}</div>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <h3 class="text-lg font-bold mb-2 text-blue-700">Assessment Scoresheets</h3>
                    <div class="flex border-b mb-2">
                        <button class="tab-btn flex-1 p-2 text-sm font-bold active" data-tab="command">Command</button>
                        <button class="tab-btn flex-1 p-2 text-sm font-bold" data-tab="technical">Technical</button>
                        <button class="tab-btn flex-1 p-2 text-sm font-bold" data-tab="trauma">Trauma</button>
                    </div>
                    <div id="scoresheet-command" class="tab-content active">${scoresheetHTML('command')}</div>
                    <div id="scoresheet-technical" class="tab-content">${scoresheetHTML('technical')}</div>
                    <div id="scoresheet-trauma" class="tab-content">${scoresheetHTML('trauma')}</div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${casCards}</div>
            <div><h3 class="text-xl font-bold">Incident Log</h3><div id="scenario-log" class="h-40 bg-gray-50 rounded-lg p-2 mt-2 overflow-y-auto text-sm font-mono border"></div><div class="flex gap-2 mt-2"><input type="text" id="manualLogInput" class="flex-grow bg-gray-200 border-gray-300 rounded p-2" placeholder="Log instructor observation..."><button id="addLogBtn" class="btn btn-primary">Add Log</button></div></div>
            <div class="text-center"><button id="finishBtn" class="btn btn-primary w-full md:w-1/2 mt-2">Finish & Debrief</button></div>`;
        return liveSimContainer;
    }

    function bindLiveSimEvents(scenario) {
        document.getElementById('timerControlBtn').addEventListener('click', () => {
            state.paused = !state.paused;
            document.getElementById('timerControlBtn').textContent = state.paused ? 'Resume Sim' : 'Pause Sim';
            if (!state.paused && !state.timer) {
                addLog('Simulation Started.', 'command', '00:00');
                state.timer = setInterval(() => {
                    if (!state.paused) {
                        state.seconds++;
                        const mins = String(Math.floor(state.seconds/60)).padStart(2,'0');
                        const secs = String(state.seconds%60).padStart(2,'0');
                        document.getElementById('timer').textContent = `${mins}:${secs}`;
                    }
                }, 1000);
                state.simTicker = setInterval(() => {
                    if (!state.paused) simulationTick(scenario.casualties);
                    scenario.casualties.forEach(c => {
                        const el = document.getElementById(`vitals-${c.id}`);
                        if (el) el.innerHTML = vitalTrendLine(c);
                    });
                }, 30000);
            }
        });
        
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`scoresheet-${btn.dataset.tab}`).classList.add('active');
            });
        });
    }
    
    async function exportDebriefAsPdf() {
        const { jsPDF } = window.jspdf;
        const debriefScreen = document.getElementById('debrief-screen');
        if (!debriefScreen) return;
        const canvas = await html2canvas(debriefScreen);
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
            orientation: 'landscape',
            unit: 'px',
            format: [canvas.width, canvas.height]
        });
        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
        pdf.save(`UKRO-Debrief-${new Date().toISOString().slice(0,10)}.pdf`);
    }

    function renderDebrief(scenario) {
        if (state.timer) clearInterval(state.timer);
        if (state.simTicker) clearInterval(state.simTicker);
        const logHtml = incidentLog.map(entry => {
            const cls = entry.type === 'good' ? 'text-green-500' :
                        entry.type === 'bad' ? 'text-red-500' :
                        entry.type === 'command' ? 'text-amber-500' : 'text-gray-500';
            return `<div class="${cls}"><span class="text-gray-400">[${entry.time}]</span> ${entry.message}</div>`;
        }).join('');
        const scoresheetResultHtml = Object.entries(state.scenario.scoresheet).map(([category, items]) => `
            <div class="mt-2">
                <h4 class="font-bold capitalize">${category}</h4>
                <ul class="list-disc list-inside text-sm">
                    ${Object.keys(items).map(item => `<li>${item}</li>`).join('')}
                </ul>
            </div>
        `).join('');

        document.getElementById('app').innerHTML = `
        <div id="debrief-screen" class="bg-white p-6 rounded-lg shadow-lg space-y-6 border">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold">Post-Scenario Debrief</h2><div class="flex gap-2"><button id="exportPdfBtn" class="btn btn-tertiary">Export PDF</button><button id="newScenarioBtn" class="btn btn-secondary">New Scenario</button></div></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-50 p-4 rounded-lg border"><h3 class="text-xl font-bold text-amber-600">Incident Timeline</h3><div class="mt-2 space-y-1 font-mono text-sm max-h-96 overflow-y-auto">${logHtml}</div></div>
                <div class="bg-gray-50 p-4 rounded-lg border"><h3 class="text-xl font-bold text-blue-700">Scoresheet Results</h3><div class="mt-2">${scoresheetResultHtml || 'No items checked.'}</div></div>
            </div>
             <div>
                <h3 class="text-xl font-bold mb-2">Patient Vital Signs History</h3>
                ${scenario.casualties.map(c => `<div class="mb-4"><h4 class="font-bold">Casualty ${c.id+1}</h4><canvas id="chart-${c.id}"></canvas></div>`).join('')}
            </div>
        </div>`;
        
        // Draw charts
        scenario.casualties.forEach(c => {
            const ctx = document.getElementById(`chart-${c.id}`).getContext('2d');
            const data = c.vitalsHistory;
            const labels = data.map(d => `${String(Math.floor(d.time/60)).padStart(2,'0')}:${String(d.time%60).padStart(2,'0')}`);
            const interventionPoints = data.filter(d => d.intervention || d.event).map(d => ({
                x: `${String(Math.floor(d.time/60)).padStart(2,'0')}:${String(d.time%60).padStart(2,'0')}`,
                y: 100, // Position on chart
                label: d.intervention || d.event
            }));

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'HR', data: data.map(d => d.HR), borderColor: 'red', tension: 0.1, yAxisID: 'y' },
                        { label: 'SBP', data: data.map(d => d.SBP), borderColor: 'blue', tension: 0.1, yAxisID: 'y' },
                        { label: 'SpO2', data: data.map(d => d.SpO2), borderColor: 'green', tension: 0.1, yAxisID: 'y1' }
                    ]
                },
                options: {
                    scales: {
                      y: { position: 'left', title: { display: true, text: 'HR & SBP' } },
                      y1: { position: 'right', title: { display: true, text: 'SpO2 (%)' }, min: 70, max: 100 }
                    },
                    plugins: {
                        annotation: {
                            annotations: interventionPoints.map(p => ({
                                type: 'point',
                                xValue: p.x,
                                yValue: p.y,
                                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                                radius: 5
                            }))
                        }
                    }
                }
            });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
      showMenu();
      document.getElementById('app').addEventListener('click', e => {
        const target = e.target;
        if (target.id === 'genRtc' || target.id === 'genTrauma') {
          const isRtc = target.id === 'genRtc';
          const prefix = isRtc ? 'rtc' : 'trauma';
          const patientCount = parseInt(document.getElementById(`${prefix}-patients`).value, 10);
          const injurySelects = document.querySelectorAll('.patient-injury-select');
          let presetInjuries = Array.from({length: patientCount}, () => null);
          injurySelects.forEach(sel => {
              const patientIndex = parseInt(sel.dataset.patientIndex, 10);
              if (patientIndex < patientCount && sel.value) {
                  presetInjuries[patientIndex] = sel.value;
              }
          });

          const options = {
            includeEVBatteryHazard: document.getElementById(`opt-evhaz${isRtc ? '' : ''}`)?.checked,
            hazardProbability: Number(document.getElementById(`opt-hp${isRtc ? '' : '-trauma'}`)?.value) / 100,
            forceHazards: [...document.querySelectorAll(`.force-hazard${isRtc ? '' : '-trauma'}:checked`)].map(cb => cb.value),
            presetInjuries
          };
          const scenario = isRtc
            ? generateRtcScenario(parseInt(document.getElementById(`${prefix}-vehicles`)?.value || 1, 10), patientCount, options)
            : generateTraumaScenario(patientCount, options);
          scenario.scoresheets = {}; // Initialise scoresheet object
          renderSetupScreen(scenario);
          return;
        }

        if (target.id === 'backBtn') showMenu();
        if (target.id === 'printBtn') window.print();
        if (target.id === 'startSimBtn') {
            const liveSimElement = renderLiveSim(state.scenario);
            target.closest('#setup-screen').append(liveSimElement);
            bindLiveSimEvents(state.scenario);
            target.style.display = 'none';
        }
        if (target.matches('.casualty-action-btn, .scenario-action-btn, .intervention-btn, .vehicle-action-btn, .override-btn, .event-btn') || target.dataset.scoresheetItem) {
            handleActionClick(target);
        }
        if (target.id === 'addLogBtn') {
            const input = document.getElementById('manualLogInput');
            if (input.value.trim()) addLog(`<strong>Instructor:</strong> ${input.value.trim()}`, 'command');
            input.value = '';
        }
        if (target.id === 'finishBtn') renderDebrief(state.scenario);
        if (target.id === 'newScenarioBtn') showMenu();
        if (target.id === 'exportPdfBtn') exportDebriefAsPdf();
      });
    });
})();

    function showUStepOut(){
      const dlg = document.getElementById('ustepout-modal');
      if (dlg && typeof dlg.showModal === 'function') dlg.showModal();
      else alert('U-STEP-OUT reference (your browser does not support <dialog>).');
    }
  </script>

</body>
</html>
